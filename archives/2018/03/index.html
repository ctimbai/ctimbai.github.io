<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Archives: 2018/3 | çŒ¿å¤§ç™½</title>
  
  
  <meta name="description" content="ä¸“æ³¨äºLinux/äº‘è®¡ç®—/ç½‘ç»œ/CC++/Python/Goç­‰æŠ€æœ¯æ ˆ">
  

  <link rel="alternate" href="/atom.xml" title="çŒ¿å¤§ç™½">

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  
  
  <meta name="theme-color" content="#f24e32">
  
  <meta name="msapplication-TileColor" content="#f24e32">
  
  <meta name="msapplication-config" content="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicons/browserconfig.xml">
  
  
  <!-- link -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">

  
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-fonts@master/Ubuntu/Ubuntu-Regular.ttf">
  
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicon.ico" type="image/x-icon">
  
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicons/favicon-32x32.png" type="image/x-icon" sizes="32x32">
  
  <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicons/apple-touch-icon.png" type="image/png" sizes="180x180">
  
  <link rel="mask-icon" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicons/safari-pinned-tab.svg" color="#f24e32">
  
  <link rel="manifest" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@18.12.27/favicon/favicons/site.webmanifest">
  
  

  
  <link rel="stylesheet" href="/style.css">
  

  



  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar" class="material"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header material">
	<div class="wrapper">
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href="/">
        
          çŒ¿å¤§ç™½
        
      </a>
			<div class="menu">
				<ul class="h-list">
          
  					
  						<li>
								<a id="home" class="nav flat-box" href="/">
									<i class="fas fa-home fa-fw"></i>&nbsp;ä¸»é¡µ
								</a>
							</li>
      			
  						<li>
								<a id="archives" class="nav flat-box" href="/archives/">
									<i class="fas fa-archive fa-fw"></i>&nbsp;å½’æ¡£
								</a>
							</li>
      			
  						<li>
								<a id="friends" class="nav flat-box" href="/friends/">
									<i class="fas fa-users fa-fw"></i>&nbsp;å¯¼èˆª
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="æœç´¢">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu">
      <ul>
          
              
                  <li>
										<a id="home" class="nav flat-box" href="/">
											<i class="fas fa-home fa-fw"></i>&nbsp;ä¸»é¡µ
										</a>
                  </li>
              
                  <li>
										<a id="archives" class="nav flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;å½’æ¡£
										</a>
                  </li>
              
                  <li>
										<a id="friends" class="nav flat-box" href="/friends/">
											<i class="fas fa-users fa-fw"></i>&nbsp;å¯¼èˆª
										</a>
                  </li>
              
       
      </ul>
		</nav>
    </header>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            
	
    <script>
        window.subData= { title:'year : 2018.3'}
    </script>


<section class="post-list">
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        <div class="post-wrapper">
          <article class="post reveal ">
    
<section class="meta">
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/2018/03/28/tech/cloud/container/docker/Docker_åŸºç¡€æŠ€æœ¯ä¹‹_Linux_cgroups_è¯¦è§£/">
              
                  Docker åŸºç¡€æŠ€æœ¯ä¹‹ Linux cgroups è¯¦è§£
              
          </a>
      </h2>
    

    
      <time class="metatag time">
        <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;2018-03-28
      </time>
    

    
      
    
    <div class="metatag cats">
        <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;<a class="categories" href="/categories/Docker/">Docker</a>
    </div>


    

    

    

  </div>
</section>

    <section class="article typo">
        <blockquote>
<p>æ–‡ç« é¦–å‘äºæˆ‘çš„å…¬ä¼—å·ã€ŒLinuxäº‘è®¡ç®—ç½‘ç»œã€ï¼Œæ¬¢è¿å…³æ³¨ï¼Œç¬¬ä¸€æ—¶é—´æŒæ¡æŠ€æœ¯å¹²è´§ï¼</p>
</blockquote>
<p>å‰é¢ä¸¤ç¯‡æ–‡ç« æˆ‘ä»¬æ€»ç»“äº† Docker èƒŒåä½¿ç”¨çš„èµ„æºéš”ç¦»æŠ€æœ¯ Linux namespaceï¼Œæœ¬ç¯‡å°†è®¨è®ºå¦å¤–ä¸€ä¸ªæŠ€æœ¯â€”â€”èµ„æºé™é¢ï¼Œè¿™æ˜¯ç”± Linux cgroups æ¥å®ç°çš„ã€‚</p>
<blockquote>
<p>cgroups æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶å¯ä»¥æ ¹æ®éœ€æ±‚æŠŠä¸€ç³»åˆ—ä»»åŠ¡åŠå­ä»»åŠ¡æ•´åˆï¼ˆæˆ–åˆ†éš”ï¼‰åˆ°æŒ‰èµ„æºåˆ’åˆ†ç­‰çº§çš„ä¸åŒç»„å†…ï¼Œä»è€Œä¸ºç³»ç»Ÿèµ„æºç®¡ç†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ã€‚ï¼ˆæ¥è‡ª ã€ŠDocker å®¹å™¨ä¸å®¹å™¨äº‘ã€‹ï¼‰</p>
</blockquote>
<p>é€šä¿—æ¥è¯´ï¼Œcgroups å¯ä»¥é™åˆ¶å’Œè®°å½•ä»»åŠ¡ç»„ï¼ˆè¿›ç¨‹ç»„æˆ–çº¿ç¨‹ç»„ï¼‰ä½¿ç”¨çš„ç‰©ç†èµ„æºï¼ˆåŒ…æ‹¬ CPUã€å†…å­˜ã€IO ç­‰ï¼‰ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ï¼ˆç¨‹åºå‘˜ï¼‰æ“ä½œï¼Œcgroups ä»¥ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼å®ç°ï¼Œå¹¶å¯¹å¤–æä¾› APIï¼Œç”¨æˆ·å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå°±æ˜¯å¯¹ cgroups çš„æ“ä½œã€‚</p>
<p>ä»å®ç°ä¸Šæ¥ï¼Œcgroups å®é™…ä¸Šæ˜¯ç»™æ¯ä¸ªæ‰§è¡Œä»»åŠ¡æŒ‚äº†ä¸€ä¸ªé’©å­ï¼Œå½“ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°å¯¹èµ„æºçš„åˆ†é…ä½¿ç”¨æ—¶ï¼Œå°±ä¼šè§¦å‘é’©å­ä¸Šçš„å‡½æ•°å¯¹ç›¸åº”çš„èµ„æºè¿›è¡Œæ£€æµ‹ï¼Œä»è€Œå¯¹èµ„æºè¿›è¡Œé™åˆ¶å’Œä¼˜å…ˆçº§åˆ†é…ã€‚</p>
<h3 id="cgroups-çš„ä½œç”¨"><a href="#cgroups-çš„ä½œç”¨" class="headerlink" title="cgroups çš„ä½œç”¨"></a>cgroups çš„ä½œç”¨</h3><hr>
<p>æ€»ç»“ä¸‹æ¥ï¼Œcgroups æä¾›ä»¥ä¸‹å››ä¸ªåŠŸèƒ½ï¼š</p>
<p><strong>èµ„æºé™åˆ¶ï¼š</strong> cgroups å¯ä»¥å¯¹ä»»åŠ¡ä½¿ç”¨çš„èµ„æºæ€»é¢è¿›è¡Œé™åˆ¶ï¼Œå¦‚è®¾å®šåº”ç”¨è¿è¡Œæ—¶ä½¿ç”¨å†…å­˜çš„ä¸Šé™ï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªé…é¢å°±å‘å‡º OOMï¼ˆOut of Memoryï¼‰æç¤ºã€‚</p>
<p><strong>ä¼˜å…ˆçº§åˆ†é…ï¼š</strong> é€šè¿‡åˆ†é…çš„ CPU æ—¶é—´ç‰‡æ•°é‡å’Œç£ç›˜ IO å¸¦å®½å¤§å°ï¼Œå®é™…ä¸Šå°±ç›¸å½“äºæ§åˆ¶äº†ä»»åŠ¡è¿è¡Œçš„ä¼˜å…ˆçº§ã€‚</p>
<p><strong>èµ„æºç»Ÿè®¡ï¼š</strong> cgroups å¯ä»¥ç»Ÿè®¡ç³»ç»Ÿçš„èµ„æºä½¿ç”¨ï¼Œå¦‚ CPU ä½¿ç”¨æ—¶é•¿ã€å†…å­˜ç”¨é‡ç­‰ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é€‚ç”¨äºè®¡è´¹ã€‚</p>
<p><strong>ä»»åŠ¡æ§åˆ¶ï¼š</strong> cgroups å¯ä»¥å¯¹ä»»åŠ¡æ‰§è¡ŒæŒ‚èµ·ã€æ¢å¤ç­‰æ“ä½œã€‚</p>
<h3 id="cgroups-çš„å­ç³»ç»Ÿ"><a href="#cgroups-çš„å­ç³»ç»Ÿ" class="headerlink" title="cgroups çš„å­ç³»ç»Ÿ"></a>cgroups çš„å­ç³»ç»Ÿ</h3><hr>
<p>cgroups åœ¨è®¾è®¡æ—¶æ ¹æ®ä¸åŒçš„èµ„æºç±»åˆ«åˆ†ä¸ºä¸åŒçš„å­ç³»ç»Ÿï¼Œä¸€ä¸ªå­ç³»ç»Ÿæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªèµ„æºæ§åˆ¶å™¨ï¼Œæ¯”å¦‚ CPU èµ„æºå¯¹åº” CPU å­ç³»ç»Ÿï¼Œè´Ÿè´£æ§åˆ¶ CPU æ—¶é—´ç‰‡çš„åˆ†é…ï¼Œå†…å­˜å¯¹åº”å†…å­˜å­ç³»ç»Ÿï¼Œè´Ÿè´£é™åˆ¶å†…å­˜çš„ä½¿ç”¨é‡ã€‚è¿›ä¸€æ­¥ï¼Œä¸€ä¸ªå­ç³»ç»Ÿæˆ–å¤šä¸ªå­ç³»ç»Ÿå¯ä»¥ç»„æˆä¸€ä¸ª cgroupï¼Œcgroups ä¸­çš„èµ„æºæ§åˆ¶éƒ½æ˜¯ä»¥ cgroup ä¸ºå•ä½æ¥å®ç°ï¼Œä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–è¿›ç¨‹æˆ–çº¿ç¨‹ï¼‰å¯ä»¥åŠ å…¥æŸä¸ª cgroupï¼Œä¹Ÿå¯ä»¥ä»ä¸€ä¸ª cgroup ç§»åŠ¨åˆ°å¦ä¸€ä¸ª cgroupï¼Œä½†è¿™é‡Œæœ‰ä¸€äº›é™åˆ¶ï¼Œåœ¨æ­¤å°±ä¸å†èµ˜è¿°äº†ï¼Œè¯¦ç»†æŸ¥é˜…ç›¸å…³èµ„æ–™äº†è§£ã€‚</p>
<p>å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæœ€å…³é”®çš„æ˜¯çŸ¥é“æ€ä¹ˆç”¨ï¼Œä¸‹é¢å°±é’ˆå¯¹ CPUã€å†…å­˜å’Œ IO èµ„æºæ¥çœ‹ Docker æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ</p>
<p>å¯¹äº CPUï¼ŒDocker ä½¿ç”¨å‚æ•° -c æˆ– â€“cpu-shares æ¥è®¾ç½®ä¸€ä¸ªå®¹å™¨ä½¿ç”¨çš„ CPU æƒé‡ï¼Œæƒé‡çš„å¤§å°ä¹Ÿå½±å“äº† CPU ä½¿ç”¨çš„ä¼˜å…ˆçº§ã€‚</p>
<p>å¦‚ä¸‹ï¼Œå¯åŠ¨ä¸¤ä¸ªå®¹å™¨ï¼Œå¹¶åˆ†é…ä¸åŒçš„ CPU æƒé‡ï¼Œæœ€ç»ˆ CPU ä½¿ç”¨ç‡æƒ…å†µï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --name &quot;container_A&quot; -c 1024 ubuntu</span><br><span class="line">docker run --name &quot;container_B&quot; -c 512 ubuntu</span><br></pre></td></tr></table></figure></p>
<center><img src="/images/docker/cgroup_cpu.png" alt=""></center>

<p>å½“åªæœ‰ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå³ä½¿æŒ‡å®šè¾ƒå°‘çš„ CPU æƒé‡ï¼Œå®ƒä¹Ÿä¼šå æ»¡æ•´ä¸ª CPUï¼Œè¯´æ˜è¿™ä¸ªæƒé‡åªæ˜¯ç›¸å¯¹æƒé‡ï¼Œå¦‚ä¸‹å°†ä¸Šé¢çš„ â€œcontainer_Aâ€ åœæ­¢ï¼Œâ€œcontainer_Bâ€ å°±åˆ†é…åˆ°å…¨éƒ¨å¯ç”¨çš„ CPUã€‚</p>
<center><img src="/images/docker/cgroup_cpu1.png" alt=""></center>

<p>å¯¹äºå†…å­˜ï¼ŒDocker ä½¿ç”¨ -mï¼ˆè®¾ç½®å†…å­˜çš„é™é¢ï¼‰å’Œ â€“memory-swapï¼ˆè®¾ç½®å†…å­˜å’Œ swap çš„é™é¢ï¼‰æ¥æ§åˆ¶å®¹å™¨å†…å­˜çš„ä½¿ç”¨é‡ï¼Œå¦‚ä¸‹ï¼Œç»™å®¹å™¨é™åˆ¶ 200M çš„å†…å­˜å’Œ 100M çš„ swapï¼Œç„¶åç»™å®¹å™¨å†…çš„ä¸€ä¸ªå·¥ä½œçº¿ç¨‹åˆ†é… 280M çš„å†…å­˜ï¼Œå› ä¸º 280M åœ¨å®¹è®¸çš„ 300M èŒƒå›´å†…ï¼Œæ²¡æœ‰é—®é¢˜ã€‚å…¶å†…å­˜åˆ†é…è¿‡ç¨‹æ˜¯ä¸æ–­åˆ†é…åˆé‡Šæ”¾ï¼Œå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/cgroup_mem.jpg" alt=""></center>

<p>å¦‚æœè®©å·¥ä½œçº¿ç¨‹ä½¿ç”¨å†…å­˜è¶…è¿‡ 300Mï¼Œåˆ™å‡ºç°å†…å­˜è¶…é™çš„é”™è¯¯ï¼Œå®¹å™¨é€€å‡ºï¼Œå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/cgroup_mem1.jpg" alt=""></center>

<p>å¯¹äº IO èµ„æºï¼Œå…¶ä½¿ç”¨æ–¹å¼ä¸ CPU ä¸€æ ·ï¼Œä½¿ç”¨ â€“blkio-weight æ¥è®¾ç½®å…¶ä½¿ç”¨æƒé‡ï¼ŒIO è¡¡é‡çš„ä¸¤ä¸ªæŒ‡æ ‡æ˜¯ bpsï¼ˆbyte per secondï¼Œæ¯ç§’è¯»å†™çš„æ•°æ®é‡ï¼‰ å’Œ iopsï¼ˆio per secondï¼Œ æ¯ç§’ IO çš„æ¬¡æ•°ï¼‰,å®é™…ä½¿ç”¨ï¼Œä¸€èˆ¬ä½¿ç”¨è¿™ä¸¤ä¸ªæŒ‡æ ‡æ¥è¡¡é‡ IO è¯»å†™çš„å¸¦å®½ï¼Œå‡ ç§ä½¿ç”¨å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li>â€“device-read-bpsï¼Œé™åˆ¶è¯»æŸä¸ªè®¾å¤‡çš„ bpsã€‚</li>
<li>â€“device-write-bpsï¼Œé™åˆ¶å†™æŸä¸ªè®¾å¤‡çš„ bpsã€‚</li>
<li>â€“device-read-iopsï¼Œé™åˆ¶è¯»æŸä¸ªè®¾å¤‡çš„ iopsã€‚</li>
<li>â€“device-write-iopsï¼Œé™åˆ¶å†™æŸä¸ªè®¾å¤‡çš„ iopsã€‚</li>
</ul>
<p>å‡å¦‚é™åˆ¶å®¹å™¨å¯¹å…¶æ–‡ä»¶ç³»ç»Ÿ /dev/sda çš„ bps å†™é€Ÿç‡ä¸º 30MB/sï¼Œåˆ™åœ¨å®¹å™¨ä¸­ç”¨ dd æµ‹è¯•å…¶å†™ç£ç›˜çš„é€Ÿç‡å¦‚ä¸‹ï¼Œå¯è§å°äº 30MB/sã€‚</p>
<center><img src="/images/docker/cgroup_dev.png" alt=""></center>

<p>å¦‚æœæ˜¯æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘çš„æœºå™¨å¯ä»¥è¾¾åˆ° 56.7MB/sï¼Œä¸€èˆ¬éƒ½æ˜¯è¶… 1G çš„ã€‚</p>
<center><img src="/images/docker/cgroup_dev1.png" alt=""></center>

<p>ä¸Šé¢å‡ ä¸ªèµ„æºä½¿ç”¨é™åˆ¶çš„ä¾‹å­ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯è°ƒç”¨äº† Linux kernel çš„ cgroups æœºåˆ¶æ¥å®ç°çš„ï¼Œæ¯ä¸ªå®¹å™¨åˆ›å»ºåï¼ŒLinux ä¼šä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ª cgroup ç›®å½•ï¼Œä»¥å®¹å™¨çš„ ID å‘½åï¼Œç›®å½•åœ¨ /sys/fs/cgroup/ ä¸­ï¼Œé’ˆå¯¹ä¸Šé¢çš„ CPU èµ„æºé™åˆ¶çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨  /sys/fs/cgroup/cpu/docker ä¸­çœ‹åˆ°ç›¸å…³ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/cgroup_info.jpg" alt=""></center>

<p>å…¶ä¸­ï¼Œcpu.shares ä¸­ä¿å­˜çš„å°±æ˜¯é™åˆ¶çš„æ•°å€¼ï¼Œå…¶ä»–è¿˜æœ‰å¾ˆå¤šé¡¹ï¼Œæ„Ÿå…´è¶£å¯ä»¥åŠ¨æ‰‹å®éªŒçœ‹çœ‹ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><hr>
<p>cgroups çš„ä½œç”¨ï¼Œcgroups çš„å®ç°ï¼Œcgroups çš„å­ç³»ç»Ÿæœºåˆ¶ï¼ŒCPUã€å†…å­˜å’Œ IO çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠå¯¹åº” Linux çš„ cgroups æ–‡ä»¶ç›®å½•ã€‚</p>
<p>PSï¼šæ–‡ç« æœªç»æˆ‘å…è®¸ï¼Œä¸å¾—è½¬è½½ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚</p>
<center>â€“ENDâ€“</center>

<hr>
<blockquote>
<p>æ¬¢è¿æ‰«ğŸ‘‡çš„äºŒç»´ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œåå°å›å¤ã€Œmã€ï¼Œå¯ä»¥è·å–å¾€æœŸæ‰€æœ‰æŠ€æœ¯åšæ–‡æ¨é€ï¼Œæ›´å¤šèµ„æ–™å›å¤ä¸‹åˆ—å…³é”®å­—è·å–ã€‚</p>
</blockquote>
<p><img src="/images/weichat.png" alt=""></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Linux/"><i class="fas fa-hashtag fa-fw"></i>Linux</a>
                
                    <a href="/tags/äº‘è®¡ç®—/"><i class="fas fa-hashtag fa-fw"></i>äº‘è®¡ç®—</a>
                
                    <a href="/tags/å®¹å™¨/"><i class="fas fa-hashtag fa-fw"></i>å®¹å™¨</a>
                
                    <a href="/tags/Docker/"><i class="fas fa-hashtag fa-fw"></i>Docker</a>
                
                    <a href="/tags/Cgroup/"><i class="fas fa-hashtag fa-fw"></i>Cgroup</a>
                
            </div>
        
    </section>
</article>

        </div>
      
    
      
        <div class="post-wrapper">
          <article class="post reveal ">
    
<section class="meta">
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/2018/03/13/tech/cloud/container/docker/Docker_åŸºç¡€æŠ€æœ¯ä¹‹_Linux_namespace_æºç åˆ†æ/">
              
                  Docker åŸºç¡€æŠ€æœ¯ä¹‹ Linux namespace æºç åˆ†æ
              
          </a>
      </h2>
    

    
      <time class="metatag time">
        <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;2018-03-13
      </time>
    

    
      
    
    <div class="metatag cats">
        <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;<a class="categories" href="/categories/Docker/">Docker</a>
    </div>


    

    

    

  </div>
</section>

    <section class="article typo">
        <blockquote>
<p>æ–‡ç« é¦–å‘äºæˆ‘çš„å…¬ä¼—å·ã€ŒLinuxäº‘è®¡ç®—ç½‘ç»œã€ï¼Œæ¬¢è¿å…³æ³¨ï¼Œç¬¬ä¸€æ—¶é—´æŒæ¡æŠ€æœ¯å¹²è´§ï¼</p>
</blockquote>
<p>ä¸Šç¯‡æˆ‘ä»¬ä»è¿›ç¨‹ clone çš„è§’åº¦ï¼Œç»“åˆä»£ç ç®€å•åˆ†æäº† Linux æä¾›çš„ 6 ç§ namespaceï¼Œæœ¬ç¯‡ä»æºç ä¸Šè¿›ä¸€æ­¥åˆ†æ Linux namespaceï¼Œè®©ä½ å¯¹ Docker namespace çš„éš”ç¦»æœºåˆ¶æœ‰æ›´æ·±çš„è®¤è¯†ã€‚æˆ‘ç”¨çš„æ˜¯ Linux-4.1.19 çš„ç‰ˆæœ¬ï¼Œç”±äº namespace æ¨¡å—æ›´æ–°éƒ½æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥ï¼Œåªè¦ 3.0 ä»¥ä¸Šçš„ç‰ˆæœ¬éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚</p>
<h3 id="ä»å†…æ ¸è¿›ç¨‹æè¿°ç¬¦-task-struct-å¼€å§‹åˆ‡å…¥"><a href="#ä»å†…æ ¸è¿›ç¨‹æè¿°ç¬¦-task-struct-å¼€å§‹åˆ‡å…¥" class="headerlink" title="ä»å†…æ ¸è¿›ç¨‹æè¿°ç¬¦ task_struct å¼€å§‹åˆ‡å…¥"></a>ä»å†…æ ¸è¿›ç¨‹æè¿°ç¬¦ task_struct å¼€å§‹åˆ‡å…¥</h3><hr>
<p>ç”±äº Linux namespace æ˜¯ç”¨æ¥åšè¿›ç¨‹èµ„æºéš”ç¦»çš„ï¼Œæ‰€ä»¥åœ¨è¿›ç¨‹æè¿°ç¬¦ä¸­ï¼Œä¸€å®šæœ‰ namespace æ‰€å¯¹åº”çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå¼€å§‹åˆ‡å…¥ä»£ç ã€‚</p>
<p>é¦–å…ˆæ‰¾åˆ°æè¿°è¿›ç¨‹ä¿¡æ¯ task_structï¼Œæ‰¾åˆ°æŒ‡å‘ namespace çš„ç»“æ„ struct *nsproxyï¼ˆsched.hï¼‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct task_struct &#123;</span><br><span class="line">......</span><br><span class="line">/* namespaces */</span><br><span class="line">struct nsproxy *nsproxy;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ nsproxy ç»“æ„ä½“å®šä¹‰åœ¨ nsproxy.h ä¸­ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* A structure to contain pointers to all per-process</span><br><span class="line">* namespaces - fs (mount), uts, network, sysvipc, etc.</span><br><span class="line">*</span><br><span class="line">* &apos;count&apos; is the number of tasks holding a reference.</span><br><span class="line">* The count for each namespace, then, will be the number</span><br><span class="line">* of nsproxies pointing to it, not the number of tasks.</span><br><span class="line">*</span><br><span class="line">* The nsproxy is shared by tasks which share all namespaces.</span><br><span class="line">* As soon as a single namespace is cloned or unshared, the</span><br><span class="line">* nsproxy is copied.</span><br><span class="line">*/</span><br><span class="line">struct nsproxy &#123;</span><br><span class="line">    atomic_t count;</span><br><span class="line">    struct uts_namespace *uts_ns;</span><br><span class="line">    struct ipc_namespace *ipc_ns;</span><br><span class="line">    struct mnt_namespace *mnt_ns;</span><br><span class="line">    struct pid_namespace *pid_ns;</span><br><span class="line">    struct net        *net_ns;</span><br><span class="line">&#125;;</span><br><span class="line">extern struct nsproxy init_nsproxy;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç»“æ„æ˜¯è¢«æ‰€æœ‰ namespace æ‰€å…±äº«çš„ï¼Œåªè¦ä¸€ä¸ª namespace è¢« clone äº†ï¼Œnsproxy ä¹Ÿä¼šè¢« cloneã€‚æ³¨æ„åˆ°ï¼Œç”±äº user namespace æ˜¯å’Œå…¶ä»– namespace è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥æ²¡å‡ºç°åœ¨ä¸Šè¿°ç»“æ„ä¸­ã€‚</p>
<p>åŒæ—¶ï¼Œnsproxy.h ä¸­è¿˜å®šä¹‰äº†ä¸€äº›å¯¹ namespace çš„æ“ä½œï¼ŒåŒ…æ‹¬ copy_namespaces ç­‰ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int copy_namespaces(unsigned long flags, struct task_struct *tsk);</span><br><span class="line">void exit_task_namespaces(struct task_struct *tsk);</span><br><span class="line">void switch_task_namespaces(struct task_struct *tsk, struct nsproxy *new);</span><br><span class="line">void free_nsproxy(struct nsproxy *ns);</span><br><span class="line">int unshare_nsproxy_namespaces(unsigned long, struct nsproxy **,</span><br><span class="line">struct fs_struct *);</span><br></pre></td></tr></table></figure></p>
<p>task_structï¼Œnsproxyï¼Œå‡ ç§ namespace ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<center><img src="/images/docker/ns_rela.jpg" alt=""></center>

<h3 id="å„ä¸ª-namespace-çš„åˆå§‹åŒ–"><a href="#å„ä¸ª-namespace-çš„åˆå§‹åŒ–" class="headerlink" title="å„ä¸ª namespace çš„åˆå§‹åŒ–"></a>å„ä¸ª namespace çš„åˆå§‹åŒ–</h3><hr>
<p>åœ¨å„ä¸ª namespace ç»“æ„å®šä¹‰ä¸‹éƒ½æœ‰ä¸ª init å‡½æ•°ï¼Œnsproxy ä¹Ÿæœ‰ä¸ª init_nsproxy å‡½æ•°ï¼Œinit_nsproxy åœ¨  task åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«åˆå§‹åŒ–ï¼Œé™„å¸¦çš„ï¼Œinit_nsproxy ä¸­å®šä¹‰äº†å„ä¸ª namespace çš„ init å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š<br>åœ¨ init_task å‡½æ•°ä¸­ï¼ˆinit_task.hï¼‰:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">*  INIT_TASK is used to set up the first task table, touch at</span><br><span class="line">* your own risk!. Base=0, limit=0x1fffff (=2MB)</span><br><span class="line">*/</span><br><span class="line">#define INIT_TASK(tsk)  \</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">.nsproxy  = &amp;init_nsproxy,        </span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç»§ç»­è·Ÿè¿› init_nsproxyï¼Œåœ¨ nsproxy.c ä¸­ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct nsproxy init_nsproxy = &#123;</span><br><span class="line">.count      = ATOMIC_INIT(1),</span><br><span class="line">.uts_ns      = &amp;init_uts_ns,</span><br><span class="line">#if defined(CONFIG_POSIX_MQUEUE) || defined(CONFIG_SYSVIPC)</span><br><span class="line">.ipc_ns      = &amp;init_ipc_ns,</span><br><span class="line">#endif</span><br><span class="line">.mnt_ns      = NULL,</span><br><span class="line">.pid_ns_for_children  = &amp;init_pid_ns,</span><br><span class="line">#ifdef CONFIG_NET</span><br><span class="line">.net_ns      = &amp;init_net,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>å¯è§ï¼Œinit_nsproxy ä¸­ï¼Œå¯¹ uts, ipc, pid, net éƒ½è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œä½† mount å´æ²¡æœ‰ã€‚</p>
<h3 id="åˆ›å»ºæ–°çš„-namespace"><a href="#åˆ›å»ºæ–°çš„-namespace" class="headerlink" title="åˆ›å»ºæ–°çš„ namespace"></a>åˆ›å»ºæ–°çš„ namespace</h3><hr>
<p>åˆå§‹åŒ–å®Œä¹‹åï¼Œä¸‹é¢çœ‹çœ‹å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„ namespaceï¼Œé€šè¿‡å‰é¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯é€šè¿‡ clone å‡½æ•°æ¥å®Œæˆçš„ï¼Œåœ¨ Linux kernel ä¸­ï¼Œfork/vfork() å¯¹ clone è¿›è¡Œäº†å°è£…ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#ifdef __ARCH_WANT_SYS_FORK</span><br><span class="line">SYSCALL_DEFINE0(fork)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef CONFIG_MMU</span><br><span class="line">    return do_fork(SIGCHLD, 0, 0, NULL, NULL);</span><br><span class="line">#else</span><br><span class="line">    /* can not support in nommu mode */</span><br><span class="line">    return -EINVAL;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef __ARCH_WANT_SYS_VFORK</span><br><span class="line">SYSCALL_DEFINE0(vfork)</span><br><span class="line">&#123;</span><br><span class="line">    return do_fork(CLONE_VFORK | CLONE_VM | SIGCHLD, 0, 0, NULL, NULL);</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef __ARCH_WANT_SYS_CLONE</span><br><span class="line">#ifdef CONFIG_CLONE_BACKWARDS</span><br><span class="line">SYSCALL_DEFINE5(clone, unsigned long, clone_flags, unsigned long, newsp,</span><br><span class="line">    int __user *, parent_tidptr,</span><br><span class="line">    int, tls_val,</span><br><span class="line">    int __user *, child_tidptr)</span><br><span class="line">#elif defined(CONFIG_CLONE_BACKWARDS2)</span><br><span class="line">SYSCALL_DEFINE5(clone, unsigned long, newsp, unsigned long, clone_flags,</span><br><span class="line">    int __user *, parent_tidptr,</span><br><span class="line">    int __user *, child_tidptr,</span><br><span class="line">    int, tls_val)</span><br><span class="line">#elif defined(CONFIG_CLONE_BACKWARDS3)</span><br><span class="line">SYSCALL_DEFINE6(clone, unsigned long, clone_flags, unsigned long, newsp,</span><br><span class="line">    int, stack_size,</span><br><span class="line">    int __user *, parent_tidptr,</span><br><span class="line">    int __user *, child_tidptr,</span><br><span class="line">    int, tls_val)</span><br><span class="line">#else</span><br><span class="line">SYSCALL_DEFINE5(clone, unsigned long, clone_flags, unsigned long, newsp,</span><br><span class="line">    int __user *, parent_tidptr,</span><br><span class="line">    int __user *, child_tidptr,</span><br><span class="line">    int, tls_val)</span><br><span class="line">#endif</span><br><span class="line">&#123;</span><br><span class="line">    return do_fork(clone_flags, newsp, 0, parent_tidptr, child_tidptr);</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ fork() è¿˜æ˜¯ vfork()ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° do_fork() å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">*  Ok, this is the main fork-routine.</span><br><span class="line">*</span><br><span class="line">* It copies the process, and if successful kick-starts</span><br><span class="line">* it and waits for it to finish using the VM if required.</span><br><span class="line">*/</span><br><span class="line">long do_fork(unsigned long clone_flags,</span><br><span class="line">unsigned long stack_start,</span><br><span class="line">unsigned long stack_size,</span><br><span class="line">int __user *parent_tidptr,</span><br><span class="line">int __user *child_tidptr)</span><br><span class="line">&#123;</span><br><span class="line">// åˆ›å»ºè¿›ç¨‹æè¿°ç¬¦æŒ‡é’ˆ</span><br><span class="line">    struct task_struct *p;</span><br><span class="line">    int trace = 0;</span><br><span class="line">    long nr;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* Determine whether and which event to report to ptracer.  When</span><br><span class="line">* called from kernel_thread or CLONE_UNTRACED is explicitly</span><br><span class="line">* requested, no event is reported; otherwise, report if the event</span><br><span class="line">* for the type of forking is enabled.</span><br><span class="line">*/</span><br><span class="line">if (!(clone_flags &amp; CLONE_UNTRACED)) &#123;</span><br><span class="line">    if (clone_flags &amp; CLONE_VFORK)</span><br><span class="line">        trace = PTRACE_EVENT_VFORK;</span><br><span class="line">    else if ((clone_flags &amp; CSIGNAL) != SIGCHLD)</span><br><span class="line">        trace = PTRACE_EVENT_CLONE;</span><br><span class="line">    else</span><br><span class="line">        trace = PTRACE_EVENT_FORK;</span><br><span class="line"></span><br><span class="line">    if (likely(!ptrace_event_enabled(current, trace)))</span><br><span class="line">        trace = 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶è¿›ç¨‹æè¿°ç¬¦ï¼Œè¿”å›å€¼æ˜¯ task_struct</span><br><span class="line">p = copy_process(clone_flags, stack_start, stack_size,</span><br><span class="line">child_tidptr, NULL, trace);</span><br><span class="line">/*</span><br><span class="line">* Do this prior waking up the new thread - the thread pointer</span><br><span class="line">* might get invalid after that point, if the thread exits quickly.</span><br><span class="line">*/</span><br><span class="line">if (!IS_ERR(p)) &#123;</span><br><span class="line">    struct completion vfork;</span><br><span class="line">    struct pid *pid;</span><br><span class="line"></span><br><span class="line">    trace_sched_process_fork(current, p);</span><br><span class="line"></span><br><span class="line">    // å¾—åˆ°æ–°è¿›ç¨‹æè¿°ç¬¦çš„ pid</span><br><span class="line">    pid = get_task_pid(p, PIDTYPE_PID);</span><br><span class="line">    nr = pid_vnr(pid);</span><br><span class="line"></span><br><span class="line">    if (clone_flags &amp; CLONE_PARENT_SETTID)</span><br><span class="line">    put_user(nr, parent_tidptr);</span><br><span class="line"></span><br><span class="line">    // è°ƒç”¨ vfork() æ–¹æ³•ï¼Œå®Œæˆç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œ  </span><br><span class="line">    if (clone_flags &amp; CLONE_VFORK) &#123;</span><br><span class="line">    p-&gt;vfork_done = &amp;vfork;</span><br><span class="line">    init_completion(&amp;vfork);</span><br><span class="line">    get_task_struct(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å°†æ–°è¿›ç¨‹åŠ å…¥åˆ°è°ƒåº¦å™¨ä¸­ï¼Œä¸ºå…¶åˆ†é… CPUï¼Œå‡†å¤‡æ‰§è¡Œ</span><br><span class="line">    wake_up_new_task(p);</span><br><span class="line"></span><br><span class="line">    // fork() å®Œæˆï¼Œå­è¿›ç¨‹å¼€å§‹è¿è¡Œï¼Œå¹¶è®© ptrace è·Ÿè¸ª</span><br><span class="line">    /* forking complete and child started to run, tell ptracer */</span><br><span class="line">    if (unlikely(trace))</span><br><span class="line">    ptrace_event_pid(trace, pid);</span><br><span class="line"></span><br><span class="line">    // å¦‚æœæ˜¯ vfork()ï¼Œå°†çˆ¶è¿›ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…å­è¿›ç¨‹å®Œæˆ</span><br><span class="line">    if (clone_flags &amp; CLONE_VFORK) &#123;</span><br><span class="line">    if (!wait_for_vfork_done(p, &amp;vfork))</span><br><span class="line">    ptrace_event_pid(PTRACE_EVENT_VFORK_DONE, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    put_pid(pid);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    nr = PTR_ERR(p);</span><br><span class="line">&#125;</span><br><span class="line">    return nr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>do_fork() é¦–å…ˆè°ƒç”¨ copy_process å°†çˆ¶è¿›ç¨‹ä¿¡æ¯å¤åˆ¶ç»™å­è¿›ç¨‹ï¼Œç„¶åè°ƒç”¨ vfork() å®Œæˆç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ¥ç€è°ƒç”¨ wake_up_new_task() å°†è¿›ç¨‹åŠ å…¥è°ƒåº¦å™¨ä¸­ï¼Œä¸ºä¹‹åˆ†é… CPUã€‚æœ€åï¼Œç­‰å¾…å­è¿›ç¨‹é€€å‡ºã€‚</p>
<p>copy_process():<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">static struct task_struct *copy_process(unsigned long clone_flags,</span><br><span class="line">    unsigned long stack_start,</span><br><span class="line">    unsigned long stack_size,</span><br><span class="line">    int __user *child_tidptr,</span><br><span class="line">    struct pid *pid,</span><br><span class="line">    int trace)</span><br><span class="line">&#123;</span><br><span class="line">int retval;</span><br><span class="line">// åˆ›å»ºè¿›ç¨‹æè¿°ç¬¦æŒ‡é’ˆ</span><br><span class="line">struct task_struct *p;</span><br><span class="line"></span><br><span class="line">// æ£€æŸ¥ clone flags çš„åˆæ³•æ€§ï¼Œæ¯”å¦‚ CLONE_NEWNS ä¸ CLONE_FS æ˜¯äº’æ–¥çš„</span><br><span class="line">if ((clone_flags &amp; (CLONE_NEWNS|CLONE_FS)) == (CLONE_NEWNS|CLONE_FS))</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">if ((clone_flags &amp; (CLONE_NEWUSER|CLONE_FS)) == (CLONE_NEWUSER|CLONE_FS))</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* Thread groups must share signals as well, and detached threads</span><br><span class="line">* can only be started up within the thread group.</span><br><span class="line">*/</span><br><span class="line">if ((clone_flags &amp; CLONE_THREAD) &amp;&amp; !(clone_flags &amp; CLONE_SIGHAND))</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* Shared signal handlers imply shared VM. By way of the above,</span><br><span class="line">* thread groups also imply shared VM. Blocking this case allows</span><br><span class="line">* for various simplifications in other code.</span><br><span class="line">*/</span><br><span class="line">if ((clone_flags &amp; CLONE_SIGHAND) &amp;&amp; !(clone_flags &amp; CLONE_VM))</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* Siblings of global init remain as zombies on exit since they are</span><br><span class="line">* not reaped by their parent (swapper). To solve this and to avoid</span><br><span class="line">* multi-rooted process trees, prevent global and container-inits</span><br><span class="line">* from creating siblings.</span><br><span class="line">*/</span><br><span class="line">// æ¯”å¦‚CLONE_PARENTæ—¶å¾—æ£€æŸ¥å½“å‰signal flagsæ˜¯å¦ä¸ºSIGNAL_UNKILLABLEï¼Œé˜²æ­¢kill initè¿›ç¨‹ã€‚</span><br><span class="line">if ((clone_flags &amp; CLONE_PARENT) &amp;&amp;</span><br><span class="line">current-&gt;signal-&gt;flags &amp; SIGNAL_UNKILLABLE)</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* If the new process will be in a different pid or user namespace</span><br><span class="line">* do not allow it to share a thread group or signal handlers or</span><br><span class="line">* parent with the forking task.</span><br><span class="line">*/</span><br><span class="line">if (clone_flags &amp; CLONE_SIGHAND) &#123;</span><br><span class="line">if ((clone_flags &amp; (CLONE_NEWUSER | CLONE_NEWPID)) ||</span><br><span class="line">(task_active_pid_ns(current) !=</span><br><span class="line">current-&gt;nsproxy-&gt;pid_ns_for_children))</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">retval = security_task_create(clone_flags);</span><br><span class="line">if (retval)</span><br><span class="line">goto fork_out;</span><br><span class="line"></span><br><span class="line">retval = -ENOMEM;</span><br><span class="line">// å¤åˆ¶å½“å‰çš„ task_struct</span><br><span class="line">p = dup_task_struct(current);</span><br><span class="line">if (!p)</span><br><span class="line">goto fork_out;</span><br><span class="line"></span><br><span class="line">ftrace_graph_init_task(p);</span><br><span class="line"></span><br><span class="line">rt_mutex_init_task(p);</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_PROVE_LOCKING</span><br><span class="line">DEBUG_LOCKS_WARN_ON(!p-&gt;hardirqs_enabled);</span><br><span class="line">DEBUG_LOCKS_WARN_ON(!p-&gt;softirqs_enabled);</span><br><span class="line">#endif</span><br><span class="line">retval = -EAGAIN;</span><br><span class="line"></span><br><span class="line">// æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼Œç”± OS å®šä¹‰</span><br><span class="line">if (atomic_read(&amp;p-&gt;real_cred-&gt;user-&gt;processes) &gt;=</span><br><span class="line">task_rlimit(p, RLIMIT_NPROC)) &#123;</span><br><span class="line">if (p-&gt;real_cred-&gt;user != INIT_USER &amp;&amp;</span><br><span class="line">!capable(CAP_SYS_RESOURCE) &amp;&amp; !capable(CAP_SYS_ADMIN))</span><br><span class="line">goto bad_fork_free;</span><br><span class="line">&#125;</span><br><span class="line">current-&gt;flags &amp;= ~PF_NPROC_EXCEEDED;</span><br><span class="line"></span><br><span class="line">retval = copy_creds(p, clone_flags);</span><br><span class="line">if (retval &lt; 0)</span><br><span class="line">goto bad_fork_free;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* If multiple threads are within copy_process(), then this check</span><br><span class="line">* triggers too late. This doesn&apos;t hurt, the check is only there</span><br><span class="line">* to stop root fork bombs.</span><br><span class="line">*/</span><br><span class="line">retval = -EAGAIN;</span><br><span class="line">// æ£€æŸ¥è¿›ç¨‹æ•°æ˜¯å¦è¶…è¿‡ max_threadsï¼Œç”±å†…å­˜å¤§å°å®šä¹‰</span><br><span class="line">if (nr_threads &gt;= max_threads)</span><br><span class="line">goto bad_fork_cleanup_count;</span><br><span class="line"></span><br><span class="line">// ......</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– io è®¡æ•°å™¨</span><br><span class="line">task_io_accounting_init(&amp;p-&gt;ioac);</span><br><span class="line">acct_clear_integrals(p);</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ– CPU å®šæ—¶å™¨</span><br><span class="line">posix_cpu_timers_init(p);</span><br><span class="line"></span><br><span class="line">// ......</span><br><span class="line"></span><br><span class="line">// åˆå§‹åŒ–è¿›ç¨‹æ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºè¿›ç¨‹åˆ†é… CPUï¼Œè¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º TASK_RUNNING</span><br><span class="line">/* Perform scheduler related setup. Assign this task to a CPU. */</span><br><span class="line">retval = sched_fork(clone_flags, p);</span><br><span class="line"></span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_policy;</span><br><span class="line"></span><br><span class="line">retval = perf_event_init_task(p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_policy;</span><br><span class="line">retval = audit_alloc(p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_perf;</span><br><span class="line">/* copy all the process information */</span><br><span class="line">// å¤åˆ¶æ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿï¼Œä¿¡å·å¤„ç†å‡½æ•°ã€ä¿¡å·ã€å†…å­˜ç®¡ç†ç­‰</span><br><span class="line">shm_init_task(p);</span><br><span class="line">retval = copy_semundo(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_audit;</span><br><span class="line">retval = copy_files(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_semundo;</span><br><span class="line">retval = copy_fs(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_files;</span><br><span class="line">retval = copy_sighand(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_fs;</span><br><span class="line">retval = copy_signal(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_sighand;</span><br><span class="line">retval = copy_mm(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_signal;</span><br><span class="line">// !!! å¤åˆ¶ namespace</span><br><span class="line">retval = copy_namespaces(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_mm;</span><br><span class="line">retval = copy_io(clone_flags, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_namespaces;</span><br><span class="line">// åˆå§‹åŒ–å­è¿›ç¨‹å†…æ ¸æ ˆ</span><br><span class="line">retval = copy_thread(clone_flags, stack_start, stack_size, p);</span><br><span class="line">if (retval)</span><br><span class="line">goto bad_fork_cleanup_io;</span><br><span class="line">// ä¸ºæ–°è¿›ç¨‹åˆ†é…æ–°çš„ pid</span><br><span class="line">if (pid != &amp;init_struct_pid) &#123;</span><br><span class="line">pid = alloc_pid(p-&gt;nsproxy-&gt;pid_ns_for_children);</span><br><span class="line">if (IS_ERR(pid)) &#123;</span><br><span class="line">retval = PTR_ERR(pid);</span><br><span class="line">goto bad_fork_cleanup_io;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ......</span><br><span class="line"></span><br><span class="line">// è¿”å›æ–°è¿›ç¨‹ p</span><br><span class="line">return p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>copy_process ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼šé¦–å…ˆè°ƒç”¨ dup_task_struct() å¤åˆ¶å½“å‰çš„è¿›ç¨‹æè¿°ç¬¦ä¿¡æ¯ task_structï¼Œä¸ºæ–°è¿›ç¨‹åˆ†é…æ–°çš„å †æ ˆï¼Œç¬¬äºŒæ­¥è°ƒç”¨ sched_fork() åˆå§‹åŒ–è¿›ç¨‹æ•°æ®ç»“æ„ï¼Œä¸ºå…¶åˆ†é… CPUï¼ŒæŠŠè¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º TASK_RUNNINGï¼Œæœ€åä¸€æ­¥å°±æ˜¯è°ƒç”¨ copy_namespaces() å¤åˆ¶ namesapcesã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨æœ€åä¸€æ­¥ copy_namespaces()ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* called from clone.  This now handles copy for nsproxy and all</span><br><span class="line">* namespaces therein.</span><br><span class="line">*/</span><br><span class="line">int copy_namespaces(unsigned long flags, struct task_struct *tsk)</span><br><span class="line">&#123;</span><br><span class="line">struct nsproxy *old_ns = tsk-&gt;nsproxy;</span><br><span class="line">struct user_namespace *user_ns = task_cred_xxx(tsk, user_ns);</span><br><span class="line">struct nsproxy *new_ns;</span><br><span class="line"></span><br><span class="line">if (likely(!(flags &amp; (CLONE_NEWNS | CLONE_NEWUTS | CLONE_NEWIPC |</span><br><span class="line">CLONE_NEWPID | CLONE_NEWNET)))) &#123;</span><br><span class="line">get_nsproxy(old_ns);</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!ns_capable(user_ns, CAP_SYS_ADMIN))</span><br><span class="line">return -EPERM;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* CLONE_NEWIPC must detach from the undolist: after switching</span><br><span class="line">* to a new ipc namespace, the semaphore arrays from the old</span><br><span class="line">* namespace are unreachable.  In clone parlance, CLONE_SYSVSEM</span><br><span class="line">* means share undolist with parent, so we must forbid using</span><br><span class="line">* it along with CLONE_NEWIPC.</span><br><span class="line">*/</span><br><span class="line">if ((flags &amp; (CLONE_NEWIPC | CLONE_SYSVSEM)) ==</span><br><span class="line">(CLONE_NEWIPC | CLONE_SYSVSEM)) </span><br><span class="line">return -EINVAL;</span><br><span class="line"></span><br><span class="line">new_ns = create_new_namespaces(flags, tsk, user_ns, tsk-&gt;fs);</span><br><span class="line">if (IS_ERR(new_ns))</span><br><span class="line">return  PTR_ERR(new_ns);</span><br><span class="line"></span><br><span class="line">tsk-&gt;nsproxy = new_ns;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¯è§ï¼Œcopy_namespace() ä¸»è¦åŸºäºâ€œæ—§çš„â€ namespace åˆ›å»ºâ€œæ–°çš„â€ namespaceï¼Œæ ¸å¿ƒå‡½æ•°åœ¨äº create_new_namespacesï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* Create new nsproxy and all of its the associated namespaces.</span><br><span class="line">* Return the newly created nsproxy.  Do not attach this to the task,</span><br><span class="line">* leave it to the caller to do proper locking and attach it to task.</span><br><span class="line">*/</span><br><span class="line">static struct nsproxy *create_new_namespaces(unsigned long flags,</span><br><span class="line">struct task_struct *tsk, struct user_namespace *user_ns,</span><br><span class="line">struct fs_struct *new_fs)</span><br><span class="line">&#123;</span><br><span class="line">struct nsproxy *new_nsp;</span><br><span class="line">int err;</span><br><span class="line"></span><br><span class="line">// åˆ›å»ºæ–°çš„ nsproxy</span><br><span class="line">new_nsp = create_nsproxy();</span><br><span class="line">if (!new_nsp)</span><br><span class="line">return ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">//åˆ›å»º mnt namespace</span><br><span class="line">new_nsp-&gt;mnt_ns = copy_mnt_ns(flags, tsk-&gt;nsproxy-&gt;mnt_ns, user_ns, new_fs);</span><br><span class="line">if (IS_ERR(new_nsp-&gt;mnt_ns)) &#123;</span><br><span class="line">err = PTR_ERR(new_nsp-&gt;mnt_ns);</span><br><span class="line">goto out_ns;</span><br><span class="line">&#125;</span><br><span class="line">//åˆ›å»º uts namespace</span><br><span class="line">new_nsp-&gt;uts_ns = copy_utsname(flags, user_ns, tsk-&gt;nsproxy-&gt;uts_ns);</span><br><span class="line">if (IS_ERR(new_nsp-&gt;uts_ns)) &#123;</span><br><span class="line">err = PTR_ERR(new_nsp-&gt;uts_ns);</span><br><span class="line">goto out_uts;</span><br><span class="line">&#125;</span><br><span class="line">//åˆ›å»º ipc namespace</span><br><span class="line">new_nsp-&gt;ipc_ns = copy_ipcs(flags, user_ns, tsk-&gt;nsproxy-&gt;ipc_ns);</span><br><span class="line">if (IS_ERR(new_nsp-&gt;ipc_ns)) &#123;</span><br><span class="line">err = PTR_ERR(new_nsp-&gt;ipc_ns);</span><br><span class="line">goto out_ipc;</span><br><span class="line">&#125;</span><br><span class="line">//åˆ›å»º pid namespace</span><br><span class="line">new_nsp-&gt;pid_ns_for_children =</span><br><span class="line">copy_pid_ns(flags, user_ns, tsk-&gt;nsproxy-&gt;pid_ns_for_children);</span><br><span class="line">if (IS_ERR(new_nsp-&gt;pid_ns_for_children)) &#123;</span><br><span class="line">err = PTR_ERR(new_nsp-&gt;pid_ns_for_children);</span><br><span class="line">goto out_pid;</span><br><span class="line">&#125;</span><br><span class="line">//åˆ›å»º network namespace</span><br><span class="line">new_nsp-&gt;net_ns = copy_net_ns(flags, user_ns, tsk-&gt;nsproxy-&gt;net_ns);</span><br><span class="line">if (IS_ERR(new_nsp-&gt;net_ns)) &#123;</span><br><span class="line">err = PTR_ERR(new_nsp-&gt;net_ns);</span><br><span class="line">goto out_net;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return new_nsp;</span><br><span class="line">// å‡ºé”™å¤„ç†</span><br><span class="line">out_net:</span><br><span class="line">if (new_nsp-&gt;pid_ns_for_children)</span><br><span class="line">put_pid_ns(new_nsp-&gt;pid_ns_for_children);</span><br><span class="line">out_pid:</span><br><span class="line">if (new_nsp-&gt;ipc_ns)</span><br><span class="line">put_ipc_ns(new_nsp-&gt;ipc_ns);</span><br><span class="line">out_ipc:</span><br><span class="line">if (new_nsp-&gt;uts_ns)</span><br><span class="line">put_uts_ns(new_nsp-&gt;uts_ns);</span><br><span class="line">out_uts:</span><br><span class="line">if (new_nsp-&gt;mnt_ns)</span><br><span class="line">put_mnt_ns(new_nsp-&gt;mnt_ns);</span><br><span class="line">out_ns:</span><br><span class="line">kmem_cache_free(nsproxy_cachep, new_nsp);</span><br><span class="line">return ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨create_new_namespaces()ä¸­ï¼Œåˆ†åˆ«è°ƒç”¨ create_nsproxy(), create_utsname(), create_ipcs(), create_pid_ns(), create_net_ns(), create_mnt_ns() æ¥åˆ›å»º nsproxy ç»“æ„ï¼Œutsï¼Œipcsï¼Œpidï¼Œmntï¼Œnetã€‚</p>
<p>å…·ä½“çš„å‡½æ•°æˆ‘ä»¬å°±ä¸å†åˆ†æï¼ŒåŸºæœ¬åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»å­è¿›ç¨‹åˆ›å»ºï¼Œåˆ°å­è¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯çš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿï¼ŒCPUï¼Œå†…å­˜ç®¡ç†ç­‰ï¼Œå†åˆ°å„ä¸ª namespace çš„åˆ›å»ºï¼Œéƒ½èµ°äº†ä¸€éï¼Œä¸‹é¢é™„ä¸Š namespace åˆ›å»ºçš„ä»£ç æµç¨‹å›¾ã€‚</p>
<center><img src="/images/docker/ns_call.jpg" alt=""></center>


<p>mnt namespace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">mnt namespace:</span><br><span class="line">struct mnt_namespace *copy_mnt_ns(unsigned long flags, struct mnt_namespace *ns,</span><br><span class="line">struct user_namespace *user_ns, struct fs_struct *new_fs)</span><br><span class="line">&#123;</span><br><span class="line">struct mnt_namespace *new_ns;</span><br><span class="line">struct vfsmount *rootmnt = NULL, *pwdmnt = NULL;</span><br><span class="line">struct mount *p, *q;</span><br><span class="line">struct mount *old;</span><br><span class="line">struct mount *new;</span><br><span class="line">int copy_flags;</span><br><span class="line"></span><br><span class="line">BUG_ON(!ns);</span><br><span class="line"></span><br><span class="line">if (likely(!(flags &amp; CLONE_NEWNS))) &#123;</span><br><span class="line">get_mnt_ns(ns);</span><br><span class="line">return ns;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">old = ns-&gt;root;</span><br><span class="line">// åˆ†é…æ–°çš„ mnt namespace</span><br><span class="line">new_ns = alloc_mnt_ns(user_ns);</span><br><span class="line">if (IS_ERR(new_ns))</span><br><span class="line">return new_ns;</span><br><span class="line"></span><br><span class="line">namespace_lock();</span><br><span class="line">/* First pass: copy the tree topology */</span><br><span class="line">// é¦–å…ˆ copy root è·¯å¾„</span><br><span class="line">copy_flags = CL_COPY_UNBINDABLE | CL_EXPIRE;</span><br><span class="line">if (user_ns != ns-&gt;user_ns)</span><br><span class="line">copy_flags |= CL_SHARED_TO_SLAVE | CL_UNPRIVILEGED;</span><br><span class="line">new = copy_tree(old, old-&gt;mnt.mnt_root, copy_flags);</span><br><span class="line">if (IS_ERR(new)) &#123;</span><br><span class="line">namespace_unlock();</span><br><span class="line">free_mnt_ns(new_ns);</span><br><span class="line">return ERR_CAST(new);</span><br><span class="line">&#125;</span><br><span class="line">new_ns-&gt;root = new;</span><br><span class="line">list_add_tail(&amp;new_ns-&gt;list, &amp;new-&gt;mnt_list);</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* Second pass: switch the tsk-&gt;fs-&gt;* elements and mark new vfsmounts</span><br><span class="line">* as belonging to new namespace.  We have already acquired a private</span><br><span class="line">* fs_struct, so tsk-&gt;fs-&gt;lock is not needed.</span><br><span class="line">*/</span><br><span class="line">// ä¸ºæ–°è¿›ç¨‹è®¾ç½® fs ä¿¡æ¯</span><br><span class="line">p = old;</span><br><span class="line">q = new;</span><br><span class="line">while (p) &#123;</span><br><span class="line">q-&gt;mnt_ns = new_ns;</span><br><span class="line">if (new_fs) &#123;</span><br><span class="line">if (&amp;p-&gt;mnt == new_fs-&gt;root.mnt) &#123;</span><br><span class="line">new_fs-&gt;root.mnt = mntget(&amp;q-&gt;mnt);</span><br><span class="line">rootmnt = &amp;p-&gt;mnt;</span><br><span class="line">&#125;</span><br><span class="line">if (&amp;p-&gt;mnt == new_fs-&gt;pwd.mnt) &#123;</span><br><span class="line">new_fs-&gt;pwd.mnt = mntget(&amp;q-&gt;mnt);</span><br><span class="line">pwdmnt = &amp;p-&gt;mnt;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">p = next_mnt(p, old);</span><br><span class="line">q = next_mnt(q, new);</span><br><span class="line">if (!q)</span><br><span class="line">break;</span><br><span class="line">while (p-&gt;mnt.mnt_root != q-&gt;mnt.mnt_root)</span><br><span class="line">p = next_mnt(p, old);</span><br><span class="line">&#125;</span><br><span class="line">namespace_unlock();</span><br><span class="line"></span><br><span class="line">if (rootmnt)</span><br><span class="line">mntput(rootmnt);</span><br><span class="line">if (pwdmnt)</span><br><span class="line">mntput(pwdmnt);</span><br><span class="line"></span><br><span class="line">return new_ns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œmount namespace åœ¨æ–°å»ºæ—¶ä¼šæ–°å»ºä¸€ä¸ªæ–°çš„ namespaceï¼Œç„¶åå°†çˆ¶è¿›ç¨‹çš„ namespace æ‹·è´è¿‡æ¥ï¼Œå¹¶å°† mount-&gt;mnt_ns æŒ‡å‘æ–°çš„ namespaceã€‚æ¥ç€è®¾ç½®è¿›ç¨‹çš„ root è·¯å¾„ä»¥åŠå½“å‰è·¯å¾„åˆ°æ–°çš„ namespaceï¼Œç„¶åä¸ºæ–°è¿›ç¨‹è®¾ç½®æ–°çš„ vfs ç­‰ã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œåœ¨å­è¿›ç¨‹ä¸­è¿›è¡Œ mount æ“ä½œä¸ä¼šå½±å“åˆ°çˆ¶è¿›ç¨‹ä¸­çš„ mount ä¿¡æ¯ã€‚</p>
<p>uts namespace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static inline struct uts_namespace *copy_utsname(unsigned long flags,</span><br><span class="line">struct user_namespace *user_ns, struct uts_namespace *old_ns)</span><br><span class="line">&#123;</span><br><span class="line">if (flags &amp; CLONE_NEWUTS)</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">return old_ns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>uts namespace ç›´æ¥è¿”å›çˆ¶è¿›ç¨‹ namespace ä¿¡æ¯ã€‚</p>
<p>ipc namespace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct ipc_namespace *copy_ipcs(unsigned long flags,</span><br><span class="line">struct user_namespace *user_ns, struct ipc_namespace *ns)</span><br><span class="line">&#123;</span><br><span class="line">if (!(flags &amp; CLONE_NEWIPC))</span><br><span class="line">return get_ipc_ns(ns);</span><br><span class="line">return create_ipc_ns(user_ns, ns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ipc namespace å¦‚æœæ˜¯è®¾ç½®äº†å‚æ•° CLONE_NEWIPCï¼Œåˆ™ç›´æ¥è¿”å›çˆ¶è¿›ç¨‹çš„ namespaceï¼Œå¦åˆ™è¿”å›æ–°åˆ›å»ºçš„ namespaceã€‚</p>
<p>pid namespace:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static inline struct pid_namespace *copy_pid_ns(unsigned long flags,</span><br><span class="line">struct user_namespace *user_ns, struct pid_namespace *ns)</span><br><span class="line">&#123;</span><br><span class="line">if (flags &amp; CLONE_NEWPID)</span><br><span class="line">ns = ERR_PTR(-EINVAL);</span><br><span class="line">return ns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pid namespace ç›´æ¥è¿”å›çˆ¶è¿›ç¨‹çš„ namespaceã€‚</p>
<p>net namespace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static inline struct net *copy_net_ns(unsigned long flags,</span><br><span class="line">struct user_namespace *user_ns, struct net *old_net)</span><br><span class="line">&#123;</span><br><span class="line">if (flags &amp; CLONE_NEWNET)</span><br><span class="line">return ERR_PTR(-EINVAL);</span><br><span class="line">return old_net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>net namespace ä¹Ÿæ˜¯ç›´æ¥è¿”å›çˆ¶è¿›ç¨‹çš„ namespaceã€‚</p>
<p>OKï¼Œä¸çŸ¥ä¸è§‰å†™äº†è¿™ä¹ˆå¤šï¼Œä½†å›å¤´å»çœ‹ï¼Œè¿™æ›´åƒæ˜¯ä»£ç èµ°è¯»ï¼Œåˆ†ææ·±åº¦ä¸å¤Ÿï¼Œæ›´è¯¦ç»†çš„å¤§å®¶å¯ä»¥å‚ç…§æºç ï¼Œæºç ç»“æ„è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚</p>
<p>PSï¼šæ–‡ç« æœªç»æˆ‘å…è®¸ï¼Œä¸å¾—è½¬è½½ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚</p>
<center>â€“ENDâ€“</center>

<hr>
<blockquote>
<p>æ¬¢è¿æ‰«ğŸ‘‡çš„äºŒç»´ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œåå°å›å¤ã€Œmã€ï¼Œå¯ä»¥è·å–å¾€æœŸæ‰€æœ‰æŠ€æœ¯åšæ–‡æ¨é€ï¼Œæ›´å¤šèµ„æ–™å›å¤ä¸‹åˆ—å…³é”®å­—è·å–ã€‚</p>
</blockquote>
<p><img src="/images/weichat.png" alt=""></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Linux/"><i class="fas fa-hashtag fa-fw"></i>Linux</a>
                
                    <a href="/tags/äº‘è®¡ç®—/"><i class="fas fa-hashtag fa-fw"></i>äº‘è®¡ç®—</a>
                
                    <a href="/tags/å®¹å™¨/"><i class="fas fa-hashtag fa-fw"></i>å®¹å™¨</a>
                
                    <a href="/tags/Docker/"><i class="fas fa-hashtag fa-fw"></i>Docker</a>
                
                    <a href="/tags/Namespace/"><i class="fas fa-hashtag fa-fw"></i>Namespace</a>
                
            </div>
        
    </section>
</article>

        </div>
      
    
      
        <div class="post-wrapper">
          <article class="post reveal ">
    
<section class="meta">
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/2018/03/08/tech/cloud/container/docker/Docker_åŸºç¡€æŠ€æœ¯ä¹‹_Linux_namespace_è¯¦è§£/">
              
                  Docker åŸºç¡€æŠ€æœ¯ä¹‹ Linux namespace è¯¦è§£
              
          </a>
      </h2>
    

    
      <time class="metatag time">
        <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;2018-03-08
      </time>
    

    
      
    
    <div class="metatag cats">
        <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;<a class="categories" href="/categories/Docker/">Docker</a>
    </div>


    

    

    

  </div>
</section>

    <section class="article typo">
        <blockquote>
<p>æ–‡ç« é¦–å‘äºæˆ‘çš„å…¬ä¼—å·ã€ŒLinuxäº‘è®¡ç®—ç½‘ç»œã€ï¼Œæ¬¢è¿å…³æ³¨ï¼Œç¬¬ä¸€æ—¶é—´æŒæ¡æŠ€æœ¯å¹²è´§ï¼</p>
</blockquote>
<p>Docker æ˜¯â€œæ–°ç“¶è£…æ—§é…’â€çš„äº§ç‰©ï¼Œä¾èµ–äº Linux å†…æ ¸æŠ€æœ¯ chroot ã€namespace å’Œ cgroupã€‚æœ¬ç¯‡å…ˆæ¥çœ‹ namespace æŠ€æœ¯ã€‚</p>
<p>Docker å’Œè™šæ‹ŸæœºæŠ€æœ¯ä¸€æ ·ï¼Œä»æ“ä½œç³»ç»Ÿçº§ä¸Šå®ç°äº†èµ„æºçš„éš”ç¦»ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯å®¿ä¸»æœºä¸Šçš„è¿›ç¨‹ï¼ˆå®¹å™¨è¿›ç¨‹ï¼‰ï¼Œæ‰€ä»¥èµ„æºéš”ç¦»ä¸»è¦å°±æ˜¯æŒ‡è¿›ç¨‹èµ„æºçš„éš”ç¦»ã€‚å®ç°èµ„æºéš”ç¦»çš„æ ¸å¿ƒæŠ€æœ¯å°±æ˜¯ Linux namespaceã€‚è¿™æŠ€æœ¯å’Œå¾ˆå¤šè¯­è¨€çš„å‘½åç©ºé—´çš„è®¾è®¡æ€æƒ³æ˜¯ä¸€è‡´çš„ï¼ˆå¦‚ C++ çš„ namespaceï¼‰ã€‚</p>
<p>éš”ç¦»æ„å‘³ç€å¯ä»¥æŠ½è±¡å‡ºå¤šä¸ªè½»é‡çº§çš„å†…æ ¸ï¼ˆå®¹å™¨è¿›ç¨‹ï¼‰ï¼Œè¿™äº›è¿›ç¨‹å¯ä»¥å……åˆ†åˆ©ç”¨å®¿ä¸»æœºçš„èµ„æºï¼Œå®¿ä¸»æœºæœ‰çš„èµ„æºå®¹å™¨è¿›ç¨‹éƒ½å¯ä»¥äº«æœ‰ï¼Œä½†å½¼æ­¤ä¹‹é—´æ˜¯éš”ç¦»çš„ï¼ŒåŒæ ·ï¼Œä¸åŒå®¹å™¨è¿›ç¨‹ä¹‹é—´ä½¿ç”¨èµ„æºä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œè¿™æ ·ï¼Œå½¼æ­¤ä¹‹é—´è¿›è¡Œç›¸åŒçš„æ“ä½œï¼Œéƒ½ä¸ä¼šäº’ç›¸å¹²æ‰°ï¼Œå®‰å…¨æ€§å¾—åˆ°ä¿éšœã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™äº›ç‰¹æ€§ï¼ŒLinux namespace å®ç°äº† 6 é¡¹èµ„æºéš”ç¦»ï¼ŒåŸºæœ¬ä¸Šæ¶µç›–äº†ä¸€ä¸ªå°å‹æ“ä½œç³»ç»Ÿçš„è¿è¡Œè¦ç´ ï¼ŒåŒ…æ‹¬ä¸»æœºåã€ç”¨æˆ·æƒé™ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è¿›ç¨‹å·ã€è¿›ç¨‹é—´é€šä¿¡ã€‚</p>
<center><img src="/images/docker/docker_ns.png" alt=""></center>

<p>è¿™ 6 é¡¹èµ„æºéš”ç¦»åˆ†åˆ«å¯¹åº” 6 ç§ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡ä¼ å…¥ä¸Šè¡¨ä¸­çš„å‚æ•°ï¼Œè°ƒç”¨ clone() å‡½æ•°æ¥å®Œæˆã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int clone(int (*child_func)(void *), void *child_stack, int flags, void *arg);</span><br></pre></td></tr></table></figure></p>
<p>clone() å‡½æ•°ç›¸ä¿¡å¤§å®¶éƒ½ä¸é™Œç”Ÿäº†ï¼Œå®ƒæ˜¯ fork() å‡½æ•°æ›´é€šç”¨çš„å®ç°æ–¹å¼ï¼Œé€šè¿‡è°ƒç”¨ clone()ï¼Œå¹¶ä¼ å…¥éœ€è¦éš”ç¦»èµ„æºå¯¹åº”çš„å‚æ•°ï¼Œå°±å¯ä»¥å»ºç«‹ä¸€ä¸ªå®¹å™¨äº†ï¼ˆéš”ç¦»ä»€ä¹ˆæˆ‘ä»¬è‡ªå·±æ§åˆ¶ï¼‰ã€‚</p>
<p>ä¸€ä¸ªå®¹å™¨è¿›ç¨‹ä¹Ÿå¯ä»¥å† clone() å‡ºä¸€ä¸ªå®¹å™¨è¿›ç¨‹ï¼Œè¿™æ˜¯å®¹å™¨çš„åµŒå¥—ã€‚</p>
<center><img src="/images/docker/docker_clone.jpg" alt=""></center>

<p>å¦‚æœæƒ³è¦æŸ¥çœ‹å½“å‰è¿›ç¨‹ä¸‹æœ‰å“ªäº› namespace éš”ç¦»ï¼Œå¯ä»¥æŸ¥çœ‹æ–‡ä»¶ /proc/[pid]/ns ï¼ˆæ³¨ï¼šè¯¥æ–¹æ³•ä»…é™äº 3.8 ç‰ˆæœ¬ä»¥åçš„å†…æ ¸ï¼‰ã€‚</p>
<center><img src="/images/docker/docker_shell.jpg" alt=""></center>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€é¡¹ namespace éƒ½é™„å¸¦ä¸€ä¸ªç¼–å·ï¼Œè¿™æ˜¯å”¯ä¸€æ ‡è¯† namespace çš„ï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹æŒ‡å‘çš„ namespace ç¼–å·ç›¸åŒï¼Œåˆ™è¡¨ç¤ºå®ƒä»¬åŒåœ¨è¯¥ namespace ä¸‹ã€‚åŒæ—¶ä¹Ÿæ³¨æ„åˆ°ï¼Œå¤šäº†ä¸€ä¸ª cgroupï¼Œè¿™ä¸ª namespace æ˜¯ 4.6 ç‰ˆæœ¬çš„å†…æ ¸æ‰æ”¯æŒçš„ã€‚Docker ç›®å‰å¯¹å®ƒçš„æ”¯æŒæ™®åŠåº¦è¿˜ä¸é«˜ã€‚æ‰€ä»¥æˆ‘ä»¬æš‚æ—¶å…ˆä¸è€ƒè™‘å®ƒã€‚</p>
<p>ä¸‹é¢é€šè¿‡ç®€å•çš„ä»£ç æ¥å®ç° 6 ç§ namespace çš„éš”ç¦»æ•ˆæœï¼Œè®©å¤§å®¶æœ‰ä¸ªç›´è§‚çš„å°è±¡ã€‚</p>
<h3 id="UTS-namespace"><a href="#UTS-namespace" class="headerlink" title="UTS namespace"></a>UTS namespace</h3><hr>
<p>UTS namespace æä¾›äº†ä¸»æœºåå’ŒåŸŸåçš„éš”ç¦»ï¼Œè¿™æ ·æ¯ä¸ªå®¹å™¨å°±æ‹¥æœ‰ç‹¬ç«‹çš„ä¸»æœºåå’ŒåŸŸåäº†ï¼Œåœ¨ç½‘ç»œä¸Šå°±å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ï¼Œåœ¨å®¹å™¨ä¸­å¯¹ hostname çš„å‘½åä¸ä¼šå¯¹å®¿ä¸»æœºé€ æˆä»»ä½•å½±å“ã€‚</p>
<p>é¦–å…ˆï¼Œå…ˆçœ‹æ€»ä½“çš„ä»£ç éª¨æ¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#define _GNU_SOURCE</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/wait.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sched.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#define STACK_SIZE (1024 * 1024)</span><br><span class="line"></span><br><span class="line">static char container_stack[STACK_SIZE];</span><br><span class="line">char* const container_args[] = &#123;</span><br><span class="line">    &quot;/bin/bash&quot;,</span><br><span class="line">    NULL</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// å®¹å™¨è¿›ç¨‹è¿è¡Œçš„ç¨‹åºä¸»å‡½æ•°</span><br><span class="line">int container_main(void *args)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;åœ¨å®¹å™¨è¿›ç¨‹ä¸­ï¼\n&quot;);</span><br><span class="line">    execv(container_args[0], container_args); // æ‰§è¡Œ/bin/bash   return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int args, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;ç¨‹åºå¼€å§‹\n&quot;);</span><br><span class="line">    // clone å®¹å™¨è¿›ç¨‹</span><br><span class="line">    int container_pid = clone(container_main, container_stack + STACK_SIZE, SIGCHLD, NULL);</span><br><span class="line">    // ç­‰å¾…å®¹å™¨è¿›ç¨‹ç»“æŸ</span><br><span class="line">    waitpid(container_pid, NULL, 0);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¯¥ç¨‹åºéª¨æ¶è°ƒç”¨ clone() å‡½æ•°å®ç°äº†å­è¿›ç¨‹çš„åˆ›å»ºå·¥ä½œï¼Œå¹¶å®šä¹‰å­è¿›ç¨‹çš„æ‰§è¡Œå‡½æ•°ï¼Œclone() ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šäº†å­è¿›ç¨‹è¿è¡Œçš„æ ˆç©ºé—´å¤§å°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å³ä¸ºåˆ›å»ºä¸åŒ namespace éš”ç¦»çš„å…³é”®ã€‚</p>
<p>å¯¹äº UTS namespaceï¼Œä¼ å…¥ CLONE_NEWUTSï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int container_pid = clone(container_main, container_stack + STACK_SIZE, SIGCHLD | CLONE_NEWUTS, NULL);</span><br></pre></td></tr></table></figure></p>
<p>ä¸ºäº†èƒ½å¤Ÿçœ‹å‡ºå®¹å™¨å†…å’Œå®¹å™¨å¤–ä¸»æœºåçš„å˜åŒ–ï¼Œæˆ‘ä»¬å­è¿›ç¨‹æ‰§è¡Œå‡½æ•°ä¸­åŠ å…¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sethostname(&quot;container&quot;, 9);</span><br></pre></td></tr></table></figure></p>
<p>æœ€ç»ˆè¿è¡Œå¯ä»¥çœ‹åˆ°æ•ˆæœå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/docker_show.png" alt=""></center>

<h3 id="IPC-namespace"><a href="#IPC-namespace" class="headerlink" title="IPC namespace"></a>IPC namespace</h3><hr>
<p>IPC namespace å®ç°äº†è¿›ç¨‹é—´é€šä¿¡çš„éš”ç¦»ï¼ŒåŒ…æ‹¬å¸¸è§çš„å‡ ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå¦‚ä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œè¦å®Œæˆ IPCï¼Œéœ€è¦ç”³è¯·ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œå³ IPC æ ‡è¯†ç¬¦ï¼Œæ‰€ä»¥ IPC èµ„æºéš”ç¦»ä¸»è¦å®Œæˆçš„å°±æ˜¯éš”ç¦» IPC æ ‡è¯†ç¬¦ã€‚</p>
<p>åŒæ ·ï¼Œä»£ç ä¿®æ”¹ä»…éœ€è¦åŠ å…¥å‚æ•° CLONE_NEWIPC å³å¯ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int container_pid = clone(container_main, container_stack + STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC, NULL);</span><br></pre></td></tr></table></figure></p>
<p>ä¸ºäº†çœ‹å‡ºå˜åŒ–ï¼Œé¦–å…ˆåœ¨å®¿ä¸»æœºä¸Šå»ºç«‹ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<center><img src="/images/docker/ns_ipc.png" alt=""></center>

<p>ç„¶åè¿è¡Œç¨‹åºï¼Œè¿›å…¥å®¹å™¨æŸ¥çœ‹ IPCï¼Œæ²¡æœ‰æ‰¾åˆ°åŸå…ˆå»ºç«‹çš„ IPC æ ‡è¯†ï¼Œè¾¾åˆ°äº† IPC éš”ç¦»ã€‚</p>
<center><img src="/images/docker/ns_ipc1.png" alt=""></center>

<h3 id="PID-namespace"><a href="#PID-namespace" class="headerlink" title="PID namespace"></a>PID namespace</h3><hr>
<p>PID namespace å®Œæˆçš„æ˜¯è¿›ç¨‹å·çš„éš”ç¦»ï¼ŒåŒæ ·åœ¨ clone() ä¸­åŠ å…¥ CLONE_NEWPID å‚æ•°ï¼Œå¦‚ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int container_pid = clone(container_main, container_stack + STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID, NULL);</span><br></pre></td></tr></table></figure></p>
<p>æ•ˆæœå¦‚ä¸‹ï¼Œecho $$ è¾“å‡º shell çš„ PID å·ï¼Œå‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<center><img src="/images/docker/ns_pid.png" alt=""></center>

<p>ä½†æ˜¯å¯¹äº ps/top ä¹‹ç±»å‘½ä»¤å´æ²¡æœ‰æ”¹å˜ï¼š</p>
<center><img src="/images/docker/ns_pid1.jpg" alt=""></center>

<p>åŸå› æ˜¯ ps/top ä¹‹ç±»çš„å‘½ä»¤åº•å±‚è°ƒç”¨çš„æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ /proc æ–‡ä»¶å†…å®¹ï¼Œç”±äº /proc æ–‡ä»¶ç³»ç»Ÿï¼ˆprocfsï¼‰è¿˜æ²¡æœ‰æŒ‚è½½åˆ°ä¸€ä¸ªä¸åŸ /proc ä¸åŒçš„ä½ç½®ï¼Œè‡ªç„¶åœ¨å®¹å™¨ä¸­æ˜¾ç¤ºçš„å°±æ˜¯å®¿ä¸»æœºçš„è¿›ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å®¹å™¨ä¸­é‡æ–°æŒ‚è½½ /proc å³å¯å®ç°éš”ç¦»ï¼Œå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/ns_proc.png" alt=""></center>

<p>è¿™ç§æ–¹å¼ä¼šç ´å root namespace ä¸­çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå½“é€€å‡ºå®¹å™¨æ—¶ï¼Œå¦‚æœ ps ä¼šå‡ºç°é”™è¯¯ï¼Œåªæœ‰å†é‡æ–°æŒ‚è½½ä¸€æ¬¡ /proc æ‰èƒ½æ¢å¤ã€‚</p>
<center><img src="/images/docker/ns_proc1.jpg" alt=""></center>

<p>ä¸€åŠ³æ°¸é€¸åœ°è§£å†³è¿™ä¸ªé—®é¢˜æœ€å¥½çš„æ–¹æ³•å°±æ˜¯ç”¨æ¥ä¸‹æ¥ä»‹ç»çš„ mount namespaceã€‚</p>
<h3 id="mount-namespace"><a href="#mount-namespace" class="headerlink" title="mount namespace"></a>mount namespace</h3><hr>
<p>mount namespace é€šè¿‡éš”ç¦»æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹æ¥è¾¾åˆ°å¯¹æ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»ã€‚æˆ‘ä»¬ä¾ç„¶åœ¨ä»£ç ä¸­åŠ å…¥ CLONE_NEWNS å‚æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int container_pid = clone(container_main, container_stack + STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS, NULL);</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘éªŒè¯çš„æ•ˆæœï¼Œå½“é€€å‡ºå®¹å™¨æ—¶ï¼Œè¿˜æ˜¯ä¼šæœ‰ mount é”™è¯¯ï¼Œè¿™æ²¡é“ç†ï¼Œç»å¤šæ–¹æŸ¥é˜…ï¼Œæ²¡æœ‰æ‰¾åˆ°é—®é¢˜çš„æ ¹æºï¼ˆæœ‰è°çŸ¥é“ï¼Œå¯ä»¥ç•™è¨€æŒ‡å‡ºï¼‰ã€‚</p>
<center><img src="/images/docker/ns_mount.jpg" alt=""></center>

<h3 id="Network-namespace"><a href="#Network-namespace" class="headerlink" title="Network namespace"></a>Network namespace</h3><hr>
<p>Network namespace å®ç°äº†ç½‘ç»œèµ„æºçš„éš”ç¦»ï¼ŒåŒ…æ‹¬ç½‘ç»œè®¾å¤‡ã€IPv4 å’Œ IPv6 åè®®æ ˆï¼ŒIP è·¯ç”±è¡¨ï¼Œé˜²ç«å¢™ï¼Œ/proc/net ç›®å½•ï¼Œ/sys/class/net ç›®å½•ï¼Œå¥—æ¥å­—ç­‰ã€‚</p>
<p>Network namespace ä¸åŒäºå…¶ä»– namespace å¯ä»¥ç‹¬ç«‹å·¥ä½œï¼Œè¦ä½¿å¾—å®¹å™¨è¿›ç¨‹å’Œå®¿ä¸»æœºæˆ–å…¶ä»–å®¹å™¨è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œéœ€è¦æŸç§â€œæ¡¥æ¢æœºåˆ¶â€æ¥è¿æ¥å½¼æ­¤ï¼ˆå¹¶æ²¡æœ‰çœŸæ­£çš„éš”ç¦»ï¼‰ï¼Œè¿™æ˜¯é€šè¿‡åˆ›å»º veth pair ï¼ˆè™šæ‹Ÿç½‘ç»œè®¾å¤‡å¯¹ï¼Œæœ‰ä¸¤ç«¯ï¼Œç±»ä¼¼äºç®¡é“ï¼Œæ•°æ®ä»ä¸€ç«¯ä¼ å…¥èƒ½ä»å¦ä¸€ç«¯æ”¶åˆ°ï¼Œåä¹‹äº¦ç„¶ï¼‰æ¥å®ç°çš„ã€‚å½“å»ºç«‹ Network namespace åï¼Œå†…æ ¸ä¼šé¦–å…ˆå»ºç«‹ä¸€ä¸ª docker0 ç½‘æ¡¥ï¼ŒåŠŸèƒ½ç±»ä¼¼äº Bridgeï¼Œç”¨äºå»ºç«‹å„å®¹å™¨ä¹‹é—´å’Œå®¿ä¸»æœºä¹‹é—´çš„é€šä¿¡ï¼Œå…·ä½“å°±æ˜¯åˆ†åˆ«å°† veth pair çš„ä¸¤ç«¯åˆ†åˆ«ç»‘å®šåˆ° docker0 å’Œæ–°å»ºçš„ namespace ä¸­ã€‚</p>
<center><img src="/images/docker/docker_net.jpg" alt=""></center>

<p>å’Œå…¶ä»– namespace ä¸€æ ·ï¼ŒNetwork namespace çš„åˆ›å»ºä¹Ÿæ˜¯åŠ å…¥ CLONE_NEWNET å‚æ•°å³å¯ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•éªŒè¯ä¸‹ IP åœ°å€çš„æƒ…å†µï¼Œå¦‚ä¸‹ï¼ŒIP è¢«éš”ç¦»äº†ã€‚</p>
<center><img src="/images/docker/ns_net.jpg" alt=""></center>

<h3 id="User-namespace"><a href="#User-namespace" class="headerlink" title="User namespace"></a>User namespace</h3><hr>
<p>User namespace ä¸»è¦éš”ç¦»äº†å®‰å…¨ç›¸å…³çš„æ ‡è¯†ç¬¦å’Œå±æ€§ï¼ŒåŒ…æ‹¬ç”¨æˆ· IDã€ç”¨æˆ·ç»„ IDã€root ç›®å½•ã€key ä»¥åŠç‰¹æ®Šæƒé™ã€‚ç®€å•è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„è¿›ç¨‹é€šè¿‡ clone() ä¹‹ååœ¨æ–°çš„ user namespace ä¸­å¯ä»¥æ‹¥æœ‰ä¸åŒçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œæ¯”å¦‚å¯èƒ½æ˜¯è¶…çº§ç”¨æˆ·ã€‚</p>
<p>åŒæ ·ï¼Œå¯ä»¥åŠ å…¥ CLONE_NEWUSER å‚æ•°æ¥åˆ›å»ºä¸€ä¸ª User namespaceã€‚ç„¶åå†å­è¿›ç¨‹æ‰§è¡Œå‡½æ•°ä¸­åŠ å…¥ getuid() å’Œ getpid() å¾—åˆ° namespace å†…éƒ¨çš„ User IDï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<center><img src="/images/docker/ns_user.png" alt=""></center>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨å†…éƒ¨çœ‹åˆ°çš„ UID å’Œ GID å’Œå¤–éƒ¨ä¸åŒäº†ï¼Œé»˜è®¤æ˜¾ç¤ºä¸º 65534ã€‚è¿™æ˜¯å› ä¸ºå®¹å™¨æ‰¾ä¸åˆ°å…¶çœŸæ­£çš„ UID ï¼Œæ‰€ä»¥è®¾ç½®ä¸Šäº†æœ€å¤§çš„UIDï¼ˆå…¶è®¾ç½®å®šä¹‰åœ¨/proc/sys/kernel/overflowuidï¼‰ã€‚å¦å¤–å°±æ˜¯ç”¨æˆ·å˜ä¸ºäº† nobodyï¼Œä¸å†æ˜¯ rootï¼Œè¾¾åˆ°äº†éš”ç¦»ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><hr>
<p>ä»¥ä¸Šå°±æ˜¯å¯¹ 6 ç§ namespace ä»ä»£ç ä¸Šç®€å•ç›´è§‚åœ°æ¼”ç¤ºå…¶å®ç°ï¼Œå½“ç„¶ï¼ŒçœŸæ­£çš„å®ç°æ¯”è¿™ä¸ªè¦å¤æ‚å¾—å¤šï¼Œç„¶åè¿™ 6 ç§ namespace å®é™…ä¸Šä¹Ÿæ²¡æœ‰å®Œå…¨éš”ç¦» Linux çš„èµ„æºï¼Œæ¯”å¦‚ SElinuxã€cgroup ä»¥åŠ /sys ç­‰ç›®å½•ä¸‹çš„èµ„æºæ²¡æœ‰éš”ç¦»ã€‚ç›®å‰ï¼ŒDocker åœ¨å¾ˆå¤šæ–¹é¢å·²ç»åšçš„å¾ˆå¥½ï¼Œä½†ç›¸æ¯”è™šæ‹Ÿæœºï¼Œä»ç„¶æœ‰è®¸å¤šå®‰å…¨æ€§é—®é¢˜æ€¥éœ€è§£å†³ã€‚</p>
<p>PSï¼šæ–‡ç« æœªç»æˆ‘å…è®¸ï¼Œä¸å¾—è½¬è½½ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚</p>
<center>â€“ENDâ€“</center>

<hr>
<blockquote>
<p>æ¬¢è¿æ‰«ğŸ‘‡çš„äºŒç»´ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œåå°å›å¤ã€Œmã€ï¼Œå¯ä»¥è·å–å¾€æœŸæ‰€æœ‰æŠ€æœ¯åšæ–‡æ¨é€ï¼Œæ›´å¤šèµ„æ–™å›å¤ä¸‹åˆ—å…³é”®å­—è·å–ã€‚</p>
</blockquote>
<p><img src="/images/weichat.png" alt=""></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Linux/"><i class="fas fa-hashtag fa-fw"></i>Linux</a>
                
                    <a href="/tags/äº‘è®¡ç®—/"><i class="fas fa-hashtag fa-fw"></i>äº‘è®¡ç®—</a>
                
                    <a href="/tags/å®¹å™¨/"><i class="fas fa-hashtag fa-fw"></i>å®¹å™¨</a>
                
                    <a href="/tags/Docker/"><i class="fas fa-hashtag fa-fw"></i>Docker</a>
                
                    <a href="/tags/Namespace/"><i class="fas fa-hashtag fa-fw"></i>Namespace</a>
                
                    <a href="/tags/Cgroup/"><i class="fas fa-hashtag fa-fw"></i>Cgroup</a>
                
            </div>
        
    </section>
</article>

        </div>
      
    
      
        <div class="post-wrapper">
          <article class="post reveal ">
    
<section class="meta">
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/2018/03/02/tech/cloud/container/å®¹å™¨ç”Ÿæ€ç³»ç»Ÿ/">
              
                  å®¹å™¨ç”Ÿæ€ç³»ç»Ÿ
              
          </a>
      </h2>
    

    
      <time class="metatag time">
        <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;2018-03-02
      </time>
    

    
      
    
    <div class="metatag cats">
        <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;<a class="categories" href="/categories/å®¹å™¨/">å®¹å™¨</a>
    </div>


    

    

    

  </div>
</section>

    <section class="article typo">
        <blockquote>
<p>æ–‡ç« é¦–å‘äºæˆ‘çš„å…¬ä¼—å·ã€ŒLinuxäº‘è®¡ç®—ç½‘ç»œã€ï¼Œæ¬¢è¿å…³æ³¨ï¼Œç¬¬ä¸€æ—¶é—´æŒæ¡æŠ€æœ¯å¹²è´§ï¼</p>
</blockquote>
<p>è¯´èµ·ç”Ÿæ€ï¼Œä¸ç¦è®©äººæƒ³èµ·è´¾è·ƒäº­çš„ä¹è§†ï¼Œæƒ³å½“åˆæˆ‘å¤šæ¬¡è¢«å®ƒçš„ç”Ÿæ€å¸ƒå±€ç»™éœ‡æ’¼åˆ°ï¼Œä¸€åº¦ç›¸ä¿¡å®ƒå°†è¦è¶…è¶Šç™¾åº¦ï¼Œåæ‹¥äº’è”ç½‘ä¸‰å¤§æ±Ÿå±±çš„å®åº§ï¼Œä½†æ²¡è¿‡æ—¶æ—¥ï¼Œå„ç§åŠ²çˆ†çš„æ–°é—»å°±æŠŠå®ƒæ¨åˆ°äº†é£å£æµªå°–ä¸Šï¼Œç°åœ¨æƒ³æƒ³ä¹Ÿæ˜¯è®©äººå”å˜˜ï¼Œä½†ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæ„¿å®ƒå¥½å§ï¼Œæ¯•ç«Ÿè¿™ç§æ•¢æƒ³æ•¢åšçš„ç²¾ç¥è¿˜æ˜¯å€¼å¾—æ•¬ä½©çš„ã€‚</p>
<p>å›åˆ°æŠ€æœ¯è¿™ä¸ªé¢†åŸŸï¼Œä¸å¾—ä¸è¯´ï¼ŒæŠ€æœ¯æ›´æ–°è¿­ä»£çš„é€Ÿåº¦å¿«å¾—è®©äººåº”æ¥ä¸æš‡ï¼Œå°±å®¹å™¨æŠ€æœ¯è¿™ä¸ªé¢†åŸŸæ¥è¯´ï¼Œä» Docker é¢ä¸–çŸ­çŸ­çš„ 2-3 å¹´æ—¶é—´é‡Œï¼Œå°±è¡ç”Ÿå‡ºå¤šç§ä¸ä¹‹ç›¸å…³çš„æŠ€æœ¯æ¡†æ¶ï¼Œç”±æ­¤å½¢æˆäº†ä¸€ä¸ªå°å°çš„ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<center><img src="/images/docker/docker_st.jpg" alt=""></center>

<p>ä¸€è°ˆåˆ°å®¹å™¨ï¼Œå¤§å®¶éƒ½ä¼šæƒ³åˆ° Dockerï¼Œæœ¬æ–‡ä¹Ÿä¸»è¦ä» Docker è§’åº¦æ¥è®²å®¹å™¨ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<h3 id="1-å®¹å™¨åŸºç¡€æŠ€æœ¯"><a href="#1-å®¹å™¨åŸºç¡€æŠ€æœ¯" class="headerlink" title="1 å®¹å™¨åŸºç¡€æŠ€æœ¯"></a>1 å®¹å™¨åŸºç¡€æŠ€æœ¯</h3><hr>
<p>Docker çš„æœ¬è´¨æ˜¯åˆ©ç”¨ Linux å†…æ ¸çš„ namespace å’Œ cgroups æœºåˆ¶ï¼Œæ„å»ºå‡ºä¸€ä¸ªéš”ç¦»çš„è¿›ç¨‹ï¼ˆå®¹å™¨è¿›ç¨‹ï¼‰ã€‚æ‰€ä»¥ï¼Œå®¹å™¨çš„åŸºç¡€æŠ€æœ¯ä¸»è¦æ¶‰åŠåˆ° Linux å†…æ ¸çš„ namespace å’Œ cgroups æŠ€æœ¯ã€‚</p>
<h3 id="2-å®¹å™¨æ ¸å¿ƒæŠ€æœ¯"><a href="#2-å®¹å™¨æ ¸å¿ƒæŠ€æœ¯" class="headerlink" title="2 å®¹å™¨æ ¸å¿ƒæŠ€æœ¯"></a>2 å®¹å™¨æ ¸å¿ƒæŠ€æœ¯</h3><hr>
<p>å®¹å™¨æ ¸å¿ƒæŠ€æœ¯ä¿è¯å®¹å™¨èƒ½å¤Ÿåœ¨ä¸»æœºä¸Šè¿è¡Œèµ·æ¥ï¼ŒåŒ…æ‹¬å®¹å™¨è§„èŒƒã€å®¹å™¨ runtimeã€å®¹å™¨ç®¡ç†å·¥å…·ã€å®¹å™¨å®šä¹‰å·¥å…·ã€Registry å’Œå®¹å™¨ OSã€‚</p>
<center><img src="/images/docker/docker_core.jpg" alt=""></center>

<p>å®¹å™¨è§„èŒƒæ—¨åœ¨å°†å¤šç§å®¹å™¨ï¼ˆå¦‚ OpenVZï¼Œrktï¼ŒDocker ç­‰ï¼‰èåˆåœ¨ä¸€èµ·ï¼Œè§£å†³å„ç§å…¼å®¹é—®é¢˜ï¼Œä¸ºæ­¤è¿˜ä¸“é—¨æˆç«‹äº†ä¸€ä¸ªå« OCIï¼ˆOpen Container Initiativeï¼‰çš„ç»„ç»‡æ¥ä¸“é—¨åˆ¶å®šç›¸å…³çš„å®¹å™¨è§„èŒƒã€‚</p>
<p>å®¹å™¨ runtime æ˜¯å®¹å™¨çœŸæ­£è¿è¡Œçš„åœ°æ–¹ï¼Œä¸€èˆ¬éœ€è¦ä¾èµ–å†…æ ¸ï¼Œä¹Ÿæœ‰è¿è¡Œåœ¨ä¸“é—¨åˆ¶å®šçš„å®¹å™¨ OS ä¸Šï¼Œå…³äºå®¹å™¨ OSï¼Œä¸‹é¢ä¼šåšä»‹ç»ã€‚lxc ã€runc å’Œ rkt æ˜¯ç›®å‰ä¸‰ç§ä¸»æµçš„ runtimeã€‚</p>
<blockquote>
<p>lxc æ˜¯ Linux ä¸Šè€ç‰Œçš„å®¹å™¨ runtimeã€‚Docker æœ€åˆä¹Ÿæ˜¯ç”¨ lxc ä½œä¸º runtimeã€‚<br>runc æ˜¯ Docker è‡ªå·±å¼€å‘çš„å®¹å™¨ runtimeï¼Œç¬¦åˆ oci è§„èŒƒï¼Œä¹Ÿæ˜¯ç°åœ¨ Docker çš„é»˜è®¤ runtimeã€‚<br>rkt æ˜¯ CoreOS å¼€å‘çš„å®¹å™¨ runtimeï¼Œç¬¦åˆ oci è§„èŒƒï¼Œå› è€Œèƒ½å¤Ÿè¿è¡Œ Docker çš„å®¹å™¨ã€‚</p>
</blockquote>
<blockquote>
<p>å®¹å™¨ç®¡ç†å·¥å…·æ˜¯å¯¹å¤–æä¾›ç»™ç”¨æˆ·çš„ CLI æ¥å£ï¼Œæ–¹ä¾¿ç”¨æˆ·ç®¡ç†å®¹å™¨ï¼Œå¯¹å†…ä¸ runtime äº¤äº’ã€‚å¯¹åº”äºä¸åŒçš„ runtimeï¼Œåˆ†åˆ«æœ‰ä¸‰ç§ä¸åŒçš„ç®¡ç†å·¥å…·ï¼šlxdã€docker engine å’Œ rkt cliã€‚</p>
</blockquote>
<p>å®¹å™¨å®šä¹‰å·¥å…·å…è®¸ç”¨æˆ·å®šä¹‰å®¹å™¨çš„å†…å®¹å’Œå±æ€§ï¼Œå¦‚å®¹å™¨éœ€è¦ä»€ä¹ˆé•œåƒï¼Œè£…è½½ä»€ä¹ˆåº”ç”¨ç­‰ã€‚å¸¸ç”¨æœ‰ä¸‰ç§å·¥å…·ï¼šdocker imagesã€Dockerfile å’Œ ACLï¼ˆApp Container Imageï¼‰ã€‚</p>
<blockquote>
<p>docker images æ˜¯å®¹å™¨é•œåƒï¼Œruntime ä¾æ® docker images åˆ›å»ºå®¹å™¨ã€‚dockerfile æ˜¯åŒ…å«è‹¥å¹²å‘½ä»¤çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è¿™äº›å‘½ä»¤åˆ›å»ºå‡º docker imagesã€‚ACI ä¸ docker images ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒæ˜¯ç”± CoreOS å¼€å‘çš„ rkt å®¹å™¨çš„ images æ ¼å¼ã€‚</p>
</blockquote>
<p>Registry æ˜¯å­˜æ”¾å®¹å™¨é•œåƒçš„ä»“åº“ï¼ŒåŒ…æ‹¬ Docker Registryã€Docker Hub å’Œ Quay.ioï¼Œä»¥åŠå›½å†…çš„ DaoCloud.ioã€‚ä¼ä¸šå¯ä»¥ç”¨ Docker Registry æ„å»ºç§æœ‰çš„ Registryã€‚</p>
<p>å®¹å™¨ OS ä¸åŒäº runtimeï¼Œæ˜¯ä¸“é—¨åˆ¶å®šå‡ºæ¥è¿è¡Œå®¹å™¨çš„æ“ä½œç³»ç»Ÿï¼Œä¸å¸¸è§„ OS ç›¸æ¯”ï¼Œå®¹å™¨ OS é€šå¸¸ä½“ç§¯æ›´å°ï¼Œå¯åŠ¨æ›´å¿«ã€‚å› ä¸ºæ˜¯ä¸ºå®¹å™¨å®šåˆ¶çš„ OSï¼Œé€šå¸¸å®ƒä»¬è¿è¡Œå®¹å™¨çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚ç›®å‰å·²ç»å­˜åœ¨ä¸å°‘å®¹å™¨ OSï¼ŒCoreOSã€atomic å’Œ ubuntu core æ˜¯å…¶ä¸­çš„æ°å‡ºä»£è¡¨ã€‚</p>
<h3 id="3-å®¹å™¨å¹³å°æŠ€æœ¯"><a href="#3-å®¹å™¨å¹³å°æŠ€æœ¯" class="headerlink" title="3 å®¹å™¨å¹³å°æŠ€æœ¯"></a>3 å®¹å™¨å¹³å°æŠ€æœ¯</h3><hr>
<p>éšç€å®¹å™¨éƒ¨ç½²çš„å¢å¤šï¼Œå®¹å™¨ä¹Ÿé€æ­¥è¿‡æ¸¡åˆ°å®¹å™¨äº‘ï¼Œå®¹å™¨å¹³å°æŠ€æœ¯å°±æ˜¯è®©å®¹å™¨ä½œä¸ºé›†ç¾¤åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­è¿è¡Œï¼ŒåŒ…æ‹¬äº†å®¹å™¨ç¼–æ’å¼•æ“ã€å®¹å™¨ç®¡ç†å¹³å°å’ŒåŸºäºå®¹å™¨çš„ PaaSã€‚</p>
<center><img src="/images/docker/docker_plat.jpg" alt=""></center>

<p>å®¹å™¨ç¼–æ’å¼•æ“å°±æ˜¯ç®¡ç†ã€è°ƒåº¦å®¹å™¨åœ¨é›†ç¾¤ä¸­è¿è¡Œï¼Œä»¥ä¿éšœèµ„æºçš„åˆç†åˆ©ç”¨ã€‚æœ‰åçš„ä¸‰å¤§ç¼–æ’å¼•æ“ä¸º docker swarmã€kubernetes å’Œ mesosã€‚å…¶ä¸­ï¼Œkubernetes è¿™ä¸¤å¹´è„±é¢–è€Œå‡ºï¼Œæˆä¸ºå…¶ä¸­çš„ä½¼ä½¼è€…ã€‚</p>
<p>å®¹å™¨ç®¡ç†å¹³å°æ˜¯åœ¨ç¼–æ’å¼•æ“ä¹‹ä¸Šæ›´ä¸ºé€šç”¨çš„ä¸€ä¸ªå¹³å°ï¼Œå®ƒæŠ½è±¡äº†ç¼–æ’å¼•æ“çš„åº•å±‚å®ç°ç»†èŠ‚ï¼Œèƒ½å¤Ÿæ”¯æŒå¤šç§ç¼–æ’å¼•æ“ï¼Œæä¾›å‹å¥½çš„æ¥å£ç»™ç”¨æˆ·ï¼Œæå¤§æ–¹ä¾¿äº†ç®¡ç†ã€‚Rancher å’Œ ContainerShip æ˜¯å®¹å™¨ç®¡ç†å¹³å°çš„å…¸å‹ä»£è¡¨ã€‚</p>
<p>åŸºäºå®¹å™¨çš„ PaaS åŸºäºå®¹å™¨çš„ PaaS ä¸ºå¾®æœåŠ¡åº”ç”¨å¼€å‘äººå‘˜å’Œå…¬å¸æä¾›äº†å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†åº”ç”¨çš„å¹³å°ï¼Œä½¿ç”¨æˆ·ä¸å¿…å…³å¿ƒåº•å±‚åŸºç¡€è®¾æ–½è€Œä¸“æ³¨äºåº”ç”¨çš„å¼€å‘ã€‚Deisã€Flynn å’Œ Dokku éƒ½æ˜¯å¼€æºå®¹å™¨ PaaS çš„ä»£è¡¨ã€‚</p>
<h3 id="4-å®¹å™¨æ”¯æŒæŠ€æœ¯"><a href="#4-å®¹å™¨æ”¯æŒæŠ€æœ¯" class="headerlink" title="4 å®¹å™¨æ”¯æŒæŠ€æœ¯"></a>4 å®¹å™¨æ”¯æŒæŠ€æœ¯</h3><hr>
<p>å®¹å™¨çš„å‡ºç°åˆé‡æ–°è®©ä¸€äº›å¤è€çš„æŠ€æœ¯ç„•å‘ç¬¬äºŒæ˜¥ï¼Œå¦‚ç›‘æ§ã€ç½‘ç»œã€æ•°æ®ç®¡ç†ã€æ—¥å¿—ç­‰æŠ€æœ¯ï¼Œç”±äºå®¹å™¨æŠ€æœ¯çš„ä¸åŒï¼Œéœ€è¦åˆ¶å®šç›¸åº”çš„ç¬¦åˆå®¹å™¨è§„èŒƒçš„æŠ€æœ¯æ¡†æ¶ï¼Œç”±æ­¤æœ‰äº†å®¹å™¨æ”¯æŒæŠ€æœ¯ï¼Œç”¨äºæ”¯æŒå®¹å™¨æä¾›æ›´ä¸°å¯Œèƒ½åŠ›çš„åŸºç¡€è®¾æ–½ã€‚</p>
<center><img src="/images/docker/docker_zc.jpg" alt=""></center>

<p>å…¶ä¸­åŒ…æ‹¬å®¹å™¨ç½‘ç»œã€æœåŠ¡å‘ç°ã€ç›‘æ§ã€æ•°æ®ç®¡ç†ã€æ—¥å¿—ç®¡ç†å’Œå®‰å…¨æ€§ã€‚</p>
<p>å®¹å™¨ç½‘ç»œä¸»è¦ç”¨äºè§£å†³å®¹å™¨ä¸å®¹å™¨ä¹‹é—´ï¼Œå®¹å™¨ä¸å…¶ä»–å®ä½“ä¹‹é—´çš„è¿é€šæ€§å’Œéš”ç¦»æ€§ã€‚åŒ…æ‹¬ Docker åŸç”Ÿçš„ç½‘ç»œè§£å†³æ–¹æ¡ˆ docker networkï¼Œä»¥åŠç¬¬ä¸‰æ–¹çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå¦‚  flannelã€weave å’Œ calicoã€‚</p>
<p>æœåŠ¡å‘ç°ä¿è¯å®¹å™¨ä½¿ç”¨è¿‡ç¨‹ä¸­èµ„æºåŠ¨æ€å˜åŒ–çš„æ„ŸçŸ¥æ€§ï¼Œå¦‚å½“è´Ÿè½½å¢åŠ æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„å®¹å™¨ï¼›è´Ÿè½½å‡å°ï¼Œå¤šä½™çš„å®¹å™¨ä¼šè¢«é”€æ¯ã€‚å®¹å™¨ä¹Ÿä¼šæ ¹æ® host çš„èµ„æºä½¿ç”¨æƒ…å†µåœ¨ä¸åŒ host ä¸­è¿ç§»ï¼Œå®¹å™¨çš„ IP å’Œç«¯å£ä¹Ÿä¼šéšä¹‹å‘ç”Ÿå˜åŒ–ã€‚åœ¨è¿™ç§åŠ¨æ€ç¯å¢ƒä¸‹ï¼Œå°±éœ€è¦æœ‰ä¸€ç§æœºåˆ¶æ¥æ„ŸçŸ¥è¿™ç§å˜åŒ–ï¼ŒæœåŠ¡å‘ç°å°±æ˜¯åšè¿™æ ·çš„å·¥ä½œã€‚etcdã€consul å’Œ zookeeper æ˜¯æœåŠ¡å‘ç°çš„å…¸å‹è§£å†³æ–¹æ¡ˆã€‚</p>
<p>ç›‘æ§å®¤ä¿è¯å®¹å™¨å¥åº·è¿è¡Œï¼Œä¸”è®©ç”¨æˆ·å®æ—¶äº†è§£åº”ç”¨è¿è¡ŒçŠ¶æ€çš„å·¥å…·ï¼Œé™¤äº† Docker åŸç”Ÿçš„ç›‘æ§å·¥å…· docker ps/top/stats ä¹‹å¤–ï¼Œä¹Ÿæœ‰ç¬¬ä¸‰æ–¹çš„ç›‘æ§æ–¹æ¡ˆï¼Œå¦‚ sysdigã€cAdvisor/Heapster å’Œ Weave Scope ã€‚</p>
<p>æ•°æ®ç®¡ç†ä¿è¯å®¹å™¨åœ¨ä¸åŒçš„ host ä¹‹é—´è¿ç§»æ—¶æ•°æ®çš„åŠ¨æ€è¿ç§»ã€‚æœ‰åçš„æ–¹æ¡ˆæ˜¯ Flockerã€‚</p>
<p>æ—¥å¿—ç®¡ç†ä¸ºé—®é¢˜æ’æŸ¥å’Œäº‹ä»¶ç®¡ç†æä¾›äº†é‡è¦ä¾æ®ã€‚docker logs æ˜¯ Docker åŸç”Ÿçš„æ—¥å¿—å·¥å…·ã€‚è€Œ logspout å¯¹æ—¥å¿—æä¾›äº†è·¯ç”±åŠŸèƒ½ï¼Œå®ƒå¯ä»¥æ”¶é›†ä¸åŒå®¹å™¨çš„æ—¥å¿—å¹¶è½¬å‘ç»™å…¶ä»–å·¥å…·è¿›è¡Œåå¤„ç†ã€‚</p>
<p>å®¹å™¨å®‰å…¨æ€§ä¿è¯å®¹å™¨çš„å®‰å…¨ï¼Œä¸è¢«æ”»å‡»ï¼ŒOpenSCAP èƒ½å¤Ÿå¯¹å®¹å™¨é•œåƒè¿›è¡Œæ‰«æï¼Œå‘ç°æ½œåœ¨çš„æ¼æ´ã€‚</p>
<p>PSï¼šæœ¬æ–‡å€Ÿé‰´äº†çŸ¥åäº‘è®¡ç®—åšä¸» CloudMan çš„åšæ–‡ï¼š<br><a href="http://www.cnblogs.com/CloudMan6/p/6706546.htmlï¼Œæ„Ÿè°¢" target="_blank" rel="noopener">http://www.cnblogs.com/CloudMan6/p/6706546.htmlï¼Œæ„Ÿè°¢</a> CloudMan å‘ˆç°è¿™ä¹ˆå¥½çš„å†…å®¹ã€‚</p>
<p>PSï¼šæ–‡ç« æœªç»æˆ‘å…è®¸ï¼Œä¸å¾—è½¬è½½ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚</p>
<center>â€“ENDâ€“</center>

<hr>
<blockquote>
<p>æ¬¢è¿æ‰«ğŸ‘‡çš„äºŒç»´ç å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œåå°å›å¤ã€Œmã€ï¼Œå¯ä»¥è·å–å¾€æœŸæ‰€æœ‰æŠ€æœ¯åšæ–‡æ¨é€ï¼Œæ›´å¤šèµ„æ–™å›å¤ä¸‹åˆ—å…³é”®å­—è·å–ã€‚</p>
</blockquote>
<p><img src="/images/weichat.png" alt=""></p>

        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/äº‘è®¡ç®—/"><i class="fas fa-hashtag fa-fw"></i>äº‘è®¡ç®—</a>
                
                    <a href="/tags/å®¹å™¨/"><i class="fas fa-hashtag fa-fw"></i>å®¹å™¨</a>
                
                    <a href="/tags/Docker/"><i class="fas fa-hashtag fa-fw"></i>Docker</a>
                
            </div>
        
    </section>
</article>

        </div>
      
    
</section>



<!-- æ ¹æ®ä¸»é¢˜ä¸­çš„è®¾ç½®å†³å®šæ˜¯å¦åœ¨archiveä¸­é’ˆå¯¹æ‘˜è¦éƒ¨åˆ†çš„MathJaxå…¬å¼åŠ è½½mathjax.jsæ–‡ä»¶ -->






        </div>
        <aside class='l_side'>
            
  
  
    
      
      
        <section class="plain">
  
<header class="material">
  <div><i class="fas fa-bullhorn fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;å…¬å‘Š</div>
  
</header>

  <div class="content material">
    <p>ä½ å¥½ï¼Œè¿™é‡Œæ˜¯<a href="https://ctimbai.github.io">çŒ¿å¤§ç™½</a>ï¼Œæˆ‘åœ¨è¿™é‡Œåˆ†äº«æŠ€æœ¯å’Œç”Ÿæ´»ï¼Œä¸“æ³¨äºLinux/äº‘è®¡ç®—/ç½‘ç»œ/CC++/Python/Goç­‰æŠ€æœ¯æ ˆï¼Œå–œæ¬¢å·¦æ‰‹Codingï¼Œå³æ‰‹Writingï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€ŒLinuxäº‘è®¡ç®—ç½‘ç»œã€ï¼ŒæœŸå¾…ä¸ä½ ç›¸é‡~</p>

  </div>
</section>

      
    
  
    
      
      
        <section class="author">
  <div class="content material">
    
      <div class="avatar">
        <img class="avatar" src="/images/cloud.png">
      </div>
    
    
      <div class="text">
        
        
          <p>å…¬ä¼—å·ï¼šLinuxäº‘è®¡ç®—ç½‘ç»œ</p>

        
        
      </div>
    
    
  </div>
</section>

      
    
  
    
      
      
        
  <section class="category">
    
<header class="material">
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;æ‰€æœ‰åˆ†ç±»</div>
  
</header>

    <div class="content material">
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/DPDK/" href="/categories/DPDK/"><div class="name">DPDK</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Docker/" href="/categories/Docker/"><div class="name">Docker</div><div class="badge">(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Kubernetes/" href="/categories/Kubernetes/"><div class="name">Kubernetes</div><div class="badge">(14)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Linux/" href="/categories/Linux/"><div class="name">Linux</div><div class="badge">(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/OVS/" href="/categories/OVS/"><div class="name">OVS</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Python/" href="/categories/Python/"><div class="name">Python</div><div class="badge">(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/TCP-IP/" href="/categories/TCP-IP/"><div class="name">TCP/IP</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/äº‘è®¡ç®—/" href="/categories/äº‘è®¡ç®—/"><div class="name">äº‘è®¡ç®—</div><div class="badge">(7)</div></a></li>
        
          <li><a class="flat-box" title="/categories/å®¹å™¨/" href="/categories/å®¹å™¨/"><div class="name">å®¹å™¨</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/å·¥å…·/" href="/categories/å·¥å…·/"><div class="name">å·¥å…·</div><div class="badge">(8)</div></a></li>
        
          <li><a class="flat-box" title="/categories/æ€§èƒ½åˆ†æ/" href="/categories/æ€§èƒ½åˆ†æ/"><div class="name">æ€§èƒ½åˆ†æ</div><div class="badge">(5)</div></a></li>
        
          <li><a class="flat-box" title="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/" href="/categories/ç®—æ³•ä¸æ•°æ®ç»“æ„/"><div class="name">ç®—æ³•ä¸æ•°æ®ç»“æ„</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/ç½‘ç»œ/" href="/categories/ç½‘ç»œ/"><div class="name">ç½‘ç»œ</div><div class="badge">(11)</div></a></li>
        
          <li><a class="flat-box" title="/categories/ç½‘ç»œå·¥å…·/" href="/categories/ç½‘ç»œå·¥å…·/"><div class="name">ç½‘ç»œå·¥å…·</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/è™šæ‹ŸåŒ–/" href="/categories/è™šæ‹ŸåŒ–/"><div class="name">è™šæ‹ŸåŒ–</div><div class="badge">(9)</div></a></li>
        
      </ul>
    </div>
  </section>


      
    
  
    
      
      
        
  <section class="tagcloud">
    
<header class="material">
  <div><i class="fas fa-fire fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;çƒ­é—¨æ ‡ç­¾</div>
  
</header>

    <div class="content material">
      <a href="/tags/Bridge/" style="font-size: 17.08px; color: #848484">Bridge</a> <a href="/tags/CNM/" style="font-size: 14px; color: #999">CNM</a> <a href="/tags/CPU/" style="font-size: 16.31px; color: #898989">CPU</a> <a href="/tags/Cgroup/" style="font-size: 14.77px; color: #949494">Cgroup</a> <a href="/tags/DPDK/" style="font-size: 15.54px; color: #8f8f8f">DPDK</a> <a href="/tags/Django/" style="font-size: 14px; color: #999">Django</a> <a href="/tags/Docker/" style="font-size: 20.15px; color: #6f6f6f">Docker</a> <a href="/tags/I-O/" style="font-size: 14px; color: #999">I/O</a> <a href="/tags/ICMP/" style="font-size: 14px; color: #999">ICMP</a> <a href="/tags/KVM/" style="font-size: 17.08px; color: #848484">KVM</a> <a href="/tags/Kata/" style="font-size: 14px; color: #999">Kata</a> <a href="/tags/Kubernetes/" style="font-size: 21.69px; color: #656565">Kubernetes</a> <a href="/tags/LaTeX/" style="font-size: 14.77px; color: #949494">LaTeX</a> <a href="/tags/Linux/" style="font-size: 23.23px; color: #5a5a5a">Linux</a> <a href="/tags/NAT/" style="font-size: 14px; color: #999">NAT</a> <a href="/tags/NFV/" style="font-size: 14px; color: #999">NFV</a> <a href="/tags/NUMA/" style="font-size: 15.54px; color: #8f8f8f">NUMA</a> <a href="/tags/Namespace/" style="font-size: 15.54px; color: #8f8f8f">Namespace</a> <a href="/tags/Numpy/" style="font-size: 14px; color: #999">Numpy</a> <a href="/tags/OVS/" style="font-size: 16.31px; color: #898989">OVS</a> <a href="/tags/OpenFlow/" style="font-size: 14.77px; color: #949494">OpenFlow</a> <a href="/tags/OpenStack/" style="font-size: 14px; color: #999">OpenStack</a> <a href="/tags/Pouch/" style="font-size: 14px; color: #999">Pouch</a> <a href="/tags/Python/" style="font-size: 18.62px; color: #7a7a7a">Python</a> <a href="/tags/Qemu/" style="font-size: 16.31px; color: #898989">Qemu</a> <a href="/tags/SDN/" style="font-size: 14px; color: #999">SDN</a> <a href="/tags/SPDK/" style="font-size: 14px; color: #999">SPDK</a> <a href="/tags/Sublime-Text/" style="font-size: 14px; color: #999">Sublime Text</a> <a href="/tags/UIO/" style="font-size: 14px; color: #999">UIO</a> <a href="/tags/VLAN/" style="font-size: 14.77px; color: #949494">VLAN</a> <a href="/tags/VPP/" style="font-size: 14px; color: #999">VPP</a> <a href="/tags/cacico/" style="font-size: 14px; color: #999">cacico</a> <a href="/tags/flannel/" style="font-size: 14px; color: #999">flannel</a> <a href="/tags/fstack/" style="font-size: 14px; color: #999">fstack</a> <a href="/tags/git/" style="font-size: 15.54px; color: #8f8f8f">git</a> <a href="/tags/github/" style="font-size: 14.77px; color: #949494">github</a> <a href="/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/tags/ipip/" style="font-size: 14px; color: #999">ipip</a> <a href="/tags/libnetwork/" style="font-size: 14px; color: #999">libnetwork</a> <a href="/tags/mTCP/" style="font-size: 14.77px; color: #949494">mTCP</a> <a href="/tags/macvlan/" style="font-size: 15.54px; color: #8f8f8f">macvlan</a> <a href="/tags/matplotlib/" style="font-size: 14px; color: #999">matplotlib</a> <a href="/tags/overlay/" style="font-size: 14px; color: #999">overlay</a> <a href="/tags/tap/" style="font-size: 17.08px; color: #848484">tap</a> <a href="/tags/tcpdump/" style="font-size: 14px; color: #999">tcpdump</a> <a href="/tags/tun/" style="font-size: 17.08px; color: #848484">tun</a> <a href="/tags/tunnel/" style="font-size: 14px; color: #999">tunnel</a> <a href="/tags/veth-pair/" style="font-size: 15.54px; color: #8f8f8f">veth-pair</a> <a href="/tags/vhost/" style="font-size: 14.77px; color: #949494">vhost</a> <a href="/tags/vhost-user/" style="font-size: 14px; color: #999">vhost_user</a> <a href="/tags/virtio/" style="font-size: 14.77px; color: #949494">virtio</a> <a href="/tags/vrouter/" style="font-size: 14px; color: #999">vrouter</a> <a href="/tags/weave/" style="font-size: 14px; color: #999">weave</a> <a href="/tags/ä¹±ç /" style="font-size: 14px; color: #999">ä¹±ç </a> <a href="/tags/äº‘è®¡ç®—/" style="font-size: 24px; color: #555">äº‘è®¡ç®—</a> <a href="/tags/å†…å­˜/" style="font-size: 14.77px; color: #949494">å†…å­˜</a> <a href="/tags/å¤§é¡µå†…å­˜/" style="font-size: 14px; color: #999">å¤§é¡µå†…å­˜</a> <a href="/tags/å®¹å™¨/" style="font-size: 19.38px; color: #747474">å®¹å™¨</a> <a href="/tags/å®¹å™¨ç½‘ç»œ/" style="font-size: 17.08px; color: #848484">å®¹å™¨ç½‘ç»œ</a> <a href="/tags/å¾®æœåŠ¡/" style="font-size: 14px; color: #999">å¾®æœåŠ¡</a> <a href="/tags/æ€§èƒ½åˆ†æ/" style="font-size: 17.85px; color: #7f7f7f">æ€§èƒ½åˆ†æ</a> <a href="/tags/æŠ€èƒ½å›¾è°±/" style="font-size: 14.77px; color: #949494">æŠ€èƒ½å›¾è°±</a> <a href="/tags/æ•°æ®ç»“æ„/" style="font-size: 14px; color: #999">æ•°æ®ç»“æ„</a> <a href="/tags/æ··åˆäº‘/" style="font-size: 14px; color: #999">æ··åˆäº‘</a> <a href="/tags/ç®€å†/" style="font-size: 14px; color: #999">ç®€å†</a> <a href="/tags/ç®—æ³•/" style="font-size: 14px; color: #999">ç®—æ³•</a> <a href="/tags/ç½‘ç»œ/" style="font-size: 22.46px; color: #5f5f5f">ç½‘ç»œ</a> <a href="/tags/è™šæ‹ŸåŒ–/" style="font-size: 20.92px; color: #6a6a6a">è™šæ‹ŸåŒ–</a> <a href="/tags/é›†ç¾¤/" style="font-size: 14px; color: #999">é›†ç¾¤</a> <a href="/tags/é›¶æ‹·è´/" style="font-size: 14px; color: #999">é›¶æ‹·è´</a> <a href="/tags/é›¾è®¡ç®—/" style="font-size: 14px; color: #999">é›¾è®¡ç®—</a>
    </div>
  </section>


      
    
  
    
      
      
        <section class="list">
  
<header class="material">
  <div><i class="fas fa-link fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;å‹é“¾</div>
  
</header>

  <div class="content material">
    <ul class="entry">
      
        <li><a class="flat-box" title="about/" href="/about/">
          <div class="name">
            
              <i class="fas fa-comment-dots fa-fw" aria-hidden="true"></i>
            
            &nbsp;&nbsp;å…³äºæˆ‘ / ç•™è¨€æ¿
          </div>
          
        </a></li>
      
    </ul>
  </div>
</section>

      
    
  
    
      
      
        

      
    
  


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
    <footer id="footer" class="clearfix">
  
  <br>
  <div><p>åšå®¢å†…å®¹éµå¾ª <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0) åè®®</a></p>
</div>
  <div>æœ¬ç«™ä½¿ç”¨ <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> ä½œä¸ºä¸»é¢˜ï¼Œæ€»è®¿é—®é‡ä¸º <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> æ¬¡ã€‚
  </div>
</footer>

    <script>setLoadingBarProgress(80);</script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>


  
    <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
    <script type="text/javascript">
      $(function() {
        const $reveal = $('.reveal');
    		if ($reveal.length === 0) return;
    		const sr = ScrollReveal({ distance: 0 });
    		sr.reveal('.reveal');
      });
    </script>
  
  
    <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
    <script type="text/javascript">
      $(function() {
        Waves.attach('.flat-btn', ['waves-button']);
        Waves.attach('.float-btn', ['waves-button', 'waves-float']);
        Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
        Waves.attach('.flat-box', ['waves-block']);
        Waves.attach('.float-box', ['waves-block', 'waves-float']);
        Waves.attach('.waves-image');
        Waves.init();
      });
    </script>
  
  
    <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>
  
  
  


  
  
  
    
  
  
    <script src="/js/app.js"></script>
<script src="/js/search.js"></script>
  






    <script>setLoadingBarProgress(100);</script>
</body>
</html>
